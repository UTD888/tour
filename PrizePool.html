<!DOCTYPE html>

<html lang="th">
<head>
<!-- ‚úÖ Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDqd20lb2fQSMjqsSmzUXXgQFhBNC8sB9g",
    authDomain: "luxutour-63450.firebaseapp.com",
    projectId: "luxutour-63450",
    storageBucket: "luxutour-63450.firebasestorage.app",
    messagingSenderId: "349190270077",
    appId: "1:349190270077:web:c52b936bdc2f06c7db1514",
    measurementId: "G-1F45DPS42M"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<meta charset="utf-8"/>
<title>Prize Pool</title>
<style>
    body { font-family: 'Prompt', Arial, sans-serif; background: #191c24; color: #fff; }
    .container { max-width: 550px; margin: 40px auto; background: #23263a; border-radius: 20px; box-shadow: 0 0 24px #1113; padding: 24px 30px 32px 30px; }
    h2 { margin-top: 0; font-size: 1.45em; }
    #tournamentInfo { margin-bottom: 15px; padding: 14px; border-radius: 10px; background: #262a3f; font-size: 1.1em; line-height: 1.5; }
    label { margin-right: 12px; }
    input[type=number] { width: 90px; background: #191c24; color: #fff; border: 1px solid #334; border-radius: 5px; padding: 6px 8px; margin-bottom: 6px; }
    button { padding: 7px 15px; background: #27b1ff; color: #fff; border: none; border-radius: 7px; font-size: 1em; margin: 7px 6px 9px 0; cursor: pointer; }
    button:active { background: #1999db; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #202442; border-radius: 12px; overflow: hidden; }
    th, td { padding: 8px 5px; text-align: center; }
    th { background: #293054; color: #f0f0ff; }
    tr:nth-child(even) { background: #242849; }
  </style>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }

  #tourInfo {
    background-color: #f0f0f0;
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }

  th {
    background-color: #f5f5f5;
  }

  input[type="number"] {
    width: 60px;
    padding: 5px;
    margin-left: 10px;
  }

  .highlight {
    color: green;
    font-weight: bold;
  }

  .warning {
    color: red;
    font-weight: bold;
  }

  button {
    padding: 6px 12px;
    font-size: 14px;
    margin-left: 10px;
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
<div id="tournamentInfo" style="margin:10px 0;"></div>
<!-- ‡∏ä‡πà‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô Prize Pool -->
<label>Entries <input id="entry" readonly="" type="number"/></label>
<label>Rebuy <input id="rebuy" readonly="" type="number"/></label>
<label>Add-on <input id="addon" readonly="" type="number"/></label>
<label>Buy-in <input id="buyin" readonly="" type="number"/></label>
<label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• <input id="nWinners" max="30" min="1" style="width:60px;" type="number" value="3"/></label>
<div id="prizeResult"></div>
</div>
<script>
let currentPercents = null;
let currentAwards = null;

function getSelectedTourKey() {
  const params = new URLSearchParams(window.location.search);
  return params.get('tour');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì prize pool ‡πÅ‡∏•‡∏∞ bounty pool ‡∏ï‡∏≤‡∏° type ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á
function getPrizeAndBountyPool(type, info, players) {
  const entries = players.length || 0;
  const rebuys = players.reduce((sum, p) => sum + (p.rebuyUsed || 0), 0);
  const addons = players.reduce((sum, p) => sum + (p.addonUsed ? 1 : 0), 0);

  const buyinPrice = Number(info.buyIn) || 0;
  const rebuyPrice = Number(info.rebuy) || buyinPrice;
  const addonPrice = Number(info.addon) || 0;

  if (type === 'bounty') {
    const bountyPool = (entries * buyinPrice / 2) + (rebuys * rebuyPrice / 2);
    const prizePool = bountyPool + (addons * addonPrice);
    return { prizePool, bountyPool };
  }
  // normal ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
  return { prizePool: (entries + rebuys + addons) * buyinPrice };
}

function loadTournamentFromLocalStorage() {
  const selectedKey = getSelectedTourKey();
  if (selectedKey) {
    const raw = // localStorage.getItem (replaced)(selectedKey);
    if (!raw || raw === "null" || raw === "{}") {
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ prizeSettings ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á
      localStorage.removeItem(selectedKey + '_prizeSettings');
      document.getElementById('tournamentInfo').innerHTML = '<span style="color:#e56">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ (‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</span>';
      document.getElementById('entry').value = '';
      document.getElementById('rebuy').value = '';
      document.getElementById('addon').value = '';
      document.getElementById('buyin').value = '';
      document.getElementById('nWinners').value = 3;
      document.getElementById('prizeResult').innerHTML = '';
      return;
    }
    const obj = JSON.parse(raw);
    const info = obj.info || {};
    const players = obj.players || [];
    document.getElementById('entry').value = players.length;
    document.getElementById('rebuy').value = players.reduce((sum, p) => sum + (p.rebuyUsed || 0), 0);
    document.getElementById('addon').value = players.reduce((sum, p) => sum + (p.addonUsed ? 1 : 0), 0);
    document.getElementById('buyin').value = info.buyIn || 0;
    document.getElementById('tournamentInfo').innerHTML =
      `<div>üéØ ${info.name || '-'} (${info.type || '-'})</div>\n<div>üíµ Buy-in: ${info.buyIn || '-'}</div>`;
    // Restore prize settings ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const settingsRaw = // localStorage.getItem (replaced)(selectedKey + '_prizeSettings');
    if (settingsRaw) {
      const settings = JSON.parse(settingsRaw);
      currentPercents = settings.percents;
      document.getElementById('nWinners').value = settings.nWinners;
    } else {
      currentPercents = null; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ default
      document.getElementById('nWinners').value = 3;
    }
    calculate();
  } else {
    document.getElementById('tournamentInfo').innerHTML = '<span style="color:#e56">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏ô URL</span>';
  }
}


function getDefaultPercents(n) {
  const presets = {
    1: [100],
    2: [65, 35],
    3: [50, 30, 20],
    4: [45, 25, 18, 12],
    5: [40, 23, 16, 12, 9],
    6: [35, 22, 15, 11, 9, 8],
    7: [33, 20, 14, 10, 8.5, 7.5, 7],
    8: [30, 19, 13, 9.5, 8, 7.5, 6.5, 6.5],
    9: [28, 18, 12.5, 9, 7.5, 7, 6.5, 6, 5.5],
    10: [27, 17, 12, 9, 7.5, 6.5, 6, 5.5, 5, 4.5]
  };
  if (presets[n]) return presets[n];
  const base = presets[10].slice();
  while (base.length < n) base.push(1);
  const sum = base.reduce((a, b) => a + b, 0);
  return base.map(p => +(p * 100 / sum).toFixed(2));
}

function savePrizeSettings() {
  const selectedKey = getSelectedTourKey();
  if (!selectedKey) return;
  // localStorage.setItem (replaced)(selectedKey + '_prizeSettings', JSON.stringify({
    percents: currentPercents,
    nWinners: Number(document.getElementById('nWinners').value)
  }));
}

function calculate() {
  const selectedKey = getSelectedTourKey();
  const obj = JSON.parse(// localStorage.getItem (replaced)(selectedKey) || '{}');
  const info = obj.info || {};
  const players = obj.players || [];
  const type = (info.type || 'normal').toLowerCase();

  const { prizePool, bountyPool } = getPrizeAndBountyPool(type, info, players);

  let nWinners = Number(document.getElementById('nWinners').value) || 3;
  if (nWinners < 1) nWinners = 1;
  document.getElementById('nWinners').value = nWinners;

  // reset default percents ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡πâ‡∏≤ nWinners ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  if (!currentPercents || currentPercents.length !== nWinners) {
    currentPercents = getDefaultPercents(nWinners).slice();
  }
  let percents = currentPercents.slice();

  let html = `<b>Prize Pool:</b> ${prizePool ? prizePool.toLocaleString() : 0} ‡∏ö‡∏≤‡∏ó<br>`;
  if (type === 'bounty') {
    html += `<b>Bounty Pool:</b> ${bountyPool ? bountyPool.toLocaleString() : 0} ‡∏ö‡∏≤‡∏ó<br>`;
  }
  html += `<table style="width:100%;margin-top:8px;"><tr>
      <th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
      <th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡∏ö‡∏≤‡∏ó)</th>
      <th>%</th>
    </tr>`;
  let sum = 0, sumPercent = 0;
  for (let i = 0; i < nWinners; i++) {
    const award = Math.round((prizePool || 0) * percents[i] / 100);
    html += `<tr>
      <td>${i + 1}</td>
      <td><input type="number" id="award_${i}" value="${award}" style="width:90px" onchange="updateByAward(${i})"></td>
      <td><input type="number" id="percent_${i}" value="${percents[i]}" min="0" max="100" step="0.01" style="width:70px" onchange="updateByPercent(${i})">%</td>
    </tr>`;
    sum += award;
    sumPercent += percents[i];
  }
  html += `</table>
    <div style="margin-top:6px;">‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏à‡∏Å: ${sum.toLocaleString()} ‡∏ö‡∏≤‡∏ó 
    <span style="color:${(sumPercent === 100 ? 'limegreen' : 'red')}">
      (${sumPercent.toFixed(2)}%)
    </span></div>`;
  document.getElementById('prizeResult').innerHTML = html;
  savePrizeSettings();
}

function updateByAward(i) {
  const selectedKey = getSelectedTourKey();
  const obj = JSON.parse(// localStorage.getItem (replaced)(selectedKey) || '{}');
  const info = obj.info || {};
  const players = obj.players || [];
  const type = (info.type || 'normal').toLowerCase();
  const { prizePool } = getPrizeAndBountyPool(type, info, players);

  let nWinners = Number(document.getElementById('nWinners').value) || 3;
  if (nWinners < 1) nWinners = 1;
  let awards = [];
  for (let k = 0; k < nWinners; k++) {
    awards[k] = Number(document.getElementById('award_' + k).value) || 0;
  }
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  currentPercents = [];
  for (let k = 0; k < nWinners; k++) {
    if (k === i) {
      currentPercents[k] = Math.max(0, Math.min(100, Math.round(awards[k] * 10000 / prizePool) / 100));
    } else {
      currentPercents[k] = Number(document.getElementById('percent_' + k).value) || 0;
    }
  }
  calculate();
}

function updateByPercent(i) {
  let nWinners = Number(document.getElementById('nWinners').value) || 3;
  if (nWinners < 1) nWinners = 1;
  currentPercents = [];
  for (let k = 0; k < nWinners; k++) {
    currentPercents[k] = Number(document.getElementById('percent_' + k).value) || 0;
  }
  calculate();
}

window.addEventListener('DOMContentLoaded', () => {
  loadTournamentFromLocalStorage();
  ['entry', 'rebuy', 'addon', 'buyin'].forEach(id => {
    document.getElementById(id).addEventListener('input', calculate);
  });
  document.getElementById('nWinners').addEventListener('input', function() {
    let n = Number(this.value) || 3;
    if (n < 1) n = 1;
    this.value = n;
    currentPercents = null;
    calculate();
  });
});
window.addEventListener('storage', function(e) {
  const selectedKey = getSelectedTourKey();
  if (
    e.key === selectedKey || 
    e.key === selectedKey + '_prizeSettings' || 
    e.key === null
  ) {
    loadTournamentFromLocalStorage();
  }
});
</script>

<script>
  // Realtime listener for prizeSettings
  function setupRealtimePrizeListener() {
    const urlParams = new URLSearchParams(window.location.search);
    const tourKey = urlParams.get('tourKey');
    if (!tourKey) return;

    db.collection("prizeSettings").doc(tourKey)
      .onSnapshot((doc) => {
        if (doc.exists) {
          const data = doc.data();
          if (data && data.winnerCount && data.percents) {
            document.getElementById("winnerCount").value = data.winnerCount;
            renderTable(data.winnerCount, data.percents);
          }
        }
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupRealtimePrizeListener();
  });
</script>

<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  }
});
</script>

<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  const tourRef = db.collection("tournaments").doc(tourKey);

  // Load prize settings and bind to UI
  tourRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      const prize = data.prizeSettings || {};
      if (document.getElementById("entryFee")) {
        document.getElementById("entryFee").value = prize.entryFee || "";
        document.getElementById("rebuyFee").value = prize.rebuyFee || "";
        document.getElementById("addonFee").value = prize.addonFee || "";
        document.getElementById("guarantee").value = prize.guarantee || "";
        document.getElementById("totalEntry").value = prize.totalEntry || "";
        document.getElementById("prizeNote").value = prize.prizeNote || "";
      }
    }
  });

  // Save updates
  function savePrizeSettings() {
    const prizeSettings = {
      entryFee: document.getElementById("entryFee").value,
      rebuyFee: document.getElementById("rebuyFee").value,
      addonFee: document.getElementById("addonFee").value,
      guarantee: document.getElementById("guarantee").value,
      totalEntry: document.getElementById("totalEntry").value,
      prizeNote: document.getElementById("prizeNote").value,
    };
    tourRef.update({ prizeSettings }).then(() => {
      alert("Prize settings updated!");
    });
  }
</script>

</body>
</html>
