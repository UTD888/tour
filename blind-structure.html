<!DOCTYPE html>

<html lang="th">
<head>
<!-- ‚úÖ Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDqd20lb2fQSMjqsSmzUXXgQFhBNC8sB9g",
    authDomain: "luxutour-63450.firebaseapp.com",
    projectId: "luxutour-63450",
    storageBucket: "luxutour-63450.firebasestorage.app",
    messagingSenderId: "349190270077",
    appId: "1:349190270077:web:c52b936bdc2f06c7db1514",
    measurementId: "G-1F45DPS42M"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<meta charset="utf-8"/>
<title>Blind Structure Editor</title>
<style>
   body {
  font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
  background: #0f1828;
  color: #f4f7fb;
  margin: 0;
  padding: 18px;
  font-size: 18px;
}

h2, #tourNameBar {
  color: #7fd1fa;
  background: #182b47;
  border-radius: 8px;
  padding: 10px 24px;
  margin-bottom: 14px;
  font-size: 1.25em;
  font-weight: 800;
  letter-spacing: 1px;
  box-shadow: 0 2px 10px #181d2e55;
}

table {
  width: 1040px;
  min-width: 370px;
  background: #19263d;
  color: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 20px #121e35aa;
  border-collapse: separate;
  border-spacing: 0;
  overflow: hidden;
  margin: 0 auto 18px auto;
}

th, td {
  padding: 10px 6px;
  font-size: 1.08em;
  text-align: center;
  border: none;
}

th {
  background: linear-gradient(90deg,#2292f4 10%,#052452 95%);
  color: #fff;
  font-weight: 900;
  font-size: 1.10em;
  letter-spacing: 0.02em;
}

tr:not(.break) {
  background: #25345d;
  border-bottom: 1px solid #234678;
}
tr.break {
  background: #2a395a !important;
  color: #ffefae;
  font-weight: bold;
}
tr:hover:not(.break) {
  background: #213055;
}

input[type="number"], input[type="text"] {
  width: 68px;
  padding: 5px 8px;
  background: #10254d;
  color: #d0f0ff;
  border: 1.5px solid #20487e;
  border-radius: 6px;
  font-size: 1.01em;
  font-weight: 600;
  transition: border 0.18s, background 0.18s;
}
input[type="number"]:focus, input[type="text"]:focus {
  border: 2px solid #37b6fc;
  background: #14294b;
  outline: none;
  color: #fff;
}

button {
  font-size: 1em;
  padding: 7px 18px;
  background: linear-gradient(90deg,#2285e4 20%,#24bbfa 80%);
  color: #fff;
  border: none;
  border-radius: 8px;
  margin: 2px 2px 2px 0;
  font-weight: bold;
  box-shadow: 0 2px 8px #183a6555;
  transition: background 0.12s, color 0.12s, box-shadow 0.16s;
  cursor: pointer;
}
button:hover {
  background: linear-gradient(90deg,#1a75c8 20%,#36e3fc 80%);
  color: #111;
  box-shadow: 0 4px 12px #24bbfa40;
}

.delete-btn {
  color: #f97a64;
  background: none;
  border: none;
  font-size: 1.2em;
  font-weight: bold;
  cursor: pointer;
  padding: 0 7px;
  transition: color 0.18s;
}
.delete-btn:hover {
  color: #ff3737;
  background: #242b3f;
  border-radius: 50%;
}

.insert-break-btn {
  background: linear-gradient(90deg,#ffd561 10%,#2292f4 90%);
  color: #263355;
  border-radius: 9px;
  font-size: 0.96em;
  padding: 5px 12px;
  font-weight: 700;
  border: none;
}
.insert-break-btn:hover {
  background: linear-gradient(90deg,#fff9c0 10%,#38d6ff 90%);
  color: #052452;
}

#structureTable {
  margin-left: auto;
  margin-right: auto;
}

@media (max-width: 600px) {
  table { width: 98vw; min-width: 0; font-size: 11px;}
  th, td { padding: 2.5px 2.5px; font-size: 11.2px; }
  input[type="number"], input[type="text"] { width: 34px; font-size: 11px;}
  button { font-size: 11.5px; padding: 3px 8px;}
  #tourNameBar { font-size: 1em; padding: 4px; }
}
tr.break input[type="text"], tr.break input[type="number"] {
  background: #fffbe8 !important;
  color: #362d04 !important;
  font-weight: 600;
  border: 1.5px solid #ffe37a;
  border-radius: 7px;
  box-shadow: 0 2px 9px #fceabb11;
}
tr.break input[type="text"]:focus, tr.break input[type="number"]:focus {
  border: 2.2px solid #eabf4c;
  background: #fffdf6 !important;
  color: #4c380a !important;
}
tr.break input[type="text"] {
  width: 98%;
  min-width: 170px;
  max-width: 520px;
  padding: 7px 14px;
  font-size: 1.15em;
  background: #fffbe8 !important;
  color: #362d04 !important;
  font-weight: 600;
  border: 1.5px solid #ffe37a;
  border-radius: 7px;
  box-shadow: 0 2px 9px #fceabb11;
}
.btn-bar {
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 16px;
  margin: 22px 0 30px 0;
}
.btn-bar button {
  min-width: 158px;
  max-width: 320px;
}
.btn-danger, button.btn-danger {
  background: linear-gradient(90deg,#fc3d33 20%,#ffb344 90%) !important;
  color: #fff !important;
  border: none;
  font-weight: 900;
  box-shadow: 0 1px 8px #ffba3340;
  margin-left: 14px;
}
.btn-danger:hover {
  background: linear-gradient(90deg,#be1d19 0%,#ffd369 100%) !important;
  color: #fff !important;
}
.btn-bar select {
  min-width: 210px;
  max-width: 380px;
  font-size: 1em;
  margin-right: 8px;
  padding: 7px 9px;
  border-radius: 8px;
  background: #152e56;
  color: #c7e6ff;
  border: 1.4px solid #2791fa;
}
.btn-bar {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 16px;
  margin: 22px 0 30px 0;
  flex-wrap: wrap;
}
#deleteTemplateModal {
  display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  z-index: 99; background: rgba(0,0,0,0.22); align-items: center; justify-content: center;
}
#deleteTemplateModal > div {
  background: #fff; color: #222; border-radius: 13px; padding: 28px 38px 20px 38px;
  min-width: 250px; box-shadow: 0 4px 36px #2292f466; margin: auto; position: relative; text-align: center;
}
@media (max-width: 700px) {
  #deleteTemplateModal > div { min-width: 90vw; padding: 14px 7vw 14px 7vw; }
}
#infoMsg {
  position: fixed;
  top: 40px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99;
  min-width: 240px;
  text-align: center;
  padding: 16px 22px;
  background: #243b29ee;
  color: #dcffef;
  border-radius: 8px;
  font-size: 1.08em;
  font-weight: bold;
  box-shadow: 0 4px 22px #22e34a22;
  display: none;
}
#popupSavedModal {
  display: none;
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.19); z-index: 999;
  align-items: center; justify-content: center;
}
#popupSavedModal > div {
  background: #fff;
  color: #202;
  border-radius: 15px;
  padding: 32px 38px 22px 38px;
  min-width: 250px;
  max-width: 94vw;
  box-shadow: 0 6px 32px #2292f488;
  margin: auto;
  position: relative;
  text-align: center;
  font-family: inherit;
}
@media (max-width:600px){
  #popupSavedModal > div { padding:16px 2vw 16px 2vw; min-width:0; }
}


  </style>
</head>
<body>
<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
<img alt="Logo" src="luxu-logo.png" style="height:140px; border-radius:18px; margin-right:30px;"/>
<img alt="QR Code" src="luxu-qr.jpg" style="height:120px; border-radius:10px;"/>
</div>
<div id="tourNameBar" style="display:none;text-align: center;"></div>
<div id="infoMsg" style="display:none"></div>
<div id="deleteTemplateModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:99; background:rgba(0,0,0,0.22); align-items:center; justify-content:center;">
<div style="background:#fff; color:#222; border-radius:13px; padding:28px 38px 20px 38px; min-width:250px; box-shadow:0 4px 36px #2292f466; margin:auto; position:relative; text-align:center;">
<h3 style="margin-top:0; color:#1778d0;">‡∏•‡∏ö‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Structure</h3>
<select id="deleteTemplateSelect" style="min-width:180px; font-size:1.05em; padding:5px 10px;"></select><br/><br/>
<button onclick="deleteSelectedTemplate()" style="background:#ff7878; color:#fff; border:none; border-radius:7px; padding:7px 28px; font-weight:bold;">‡∏•‡∏ö</button>
<button onclick="closeDeleteTemplateModal()" style="margin-left:15px; background:#e9e9e9; color:#222; border:none; border-radius:7px; padding:7px 28px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div>
<div class="btn-bar">
<select id="templateSelect">
<option value="">-- ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Structure --</option>
</select>
<button onclick="applyTemplate()">‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö</button>
<button onclick="saveAsTemplate()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö</button>
<button ...="" onclick="showDeleteTemplateDialog()">‡∏•‡∏ö‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö</button>
<button class="btn-danger" onclick="clearStructure()">üóë ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>
<table id="structureTable">
<thead>
<tr>
<th>Level</th>
<th>SB</th>
<th>BB</th>
<th>ANTE</th>
<th>Duration</th>
<th>Time</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="btn-bar">
<button onclick="addLevel()">+ Add Level</button>
<button ...="" onclick="saveToTournament()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ</button>
</div>
<div id="popupSavedModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.19); z-index:999; align-items:center; justify-content:center;">
<div style="background:#fff; color:#202; border-radius:15px; padding:32px 38px 22px 38px; min-width:250px; box-shadow:0 6px 32px #2292f488; margin:auto; position:relative; text-align:center;">
<div style="font-size:2.4em; margin-bottom:0.4em;">‚úÖ</div>
<div style="font-size:1.3em; font-weight:bold; margin-bottom:0.8em;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
<div style="font-size:1em; margin-bottom:1.2em;">Blind Structure ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</div>
<button onclick="closeSavedModal()" style="background:#2292f4; color:#fff; border:none; border-radius:8px; padding:9px 28px; font-weight:bold; font-size:1.1em;">‡∏õ‡∏¥‡∏î</button>
</div>
</div>
<!-- ‡∏õ‡∏∏‡πà‡∏° + Add Break ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß -->
<script>
let levelCounter = 1;
let breakCounter = 1;
let currentTourKey = // localStorage.getItem (replaced)("currentTourKey") || null;

function showSavedModal() {
  document.getElementById("popupSavedModal").style.display = "flex";
  // auto-close ‡πÉ‡∏ô 2.4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  setTimeout(closeSavedModal, 5000);
}
function closeSavedModal() {
  document.getElementById("popupSavedModal").style.display = "none";
}


// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
function checkTourSelected() {
  if (!currentTourKey || !// localStorage.getItem (replaced)(currentTourKey)) {
    document.body.innerHTML = '<div id="infoMsg" style="background:#ffcccc;color:#b00020;font-size:20px;padding:32px 14px;margin-top:40px;border-radius:8px;text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô<br><br><a href="index1.html" style="color:#007bff;font-weight:bold;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå</a></div>';
    return false;
  }
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå
  const tourObj = JSON.parse(// localStorage.getItem (replaced)(currentTourKey));
  document.getElementById("tourNameBar").style.display = "";
  document.getElementById("tourNameBar").textContent = "üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ Blind Structure ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ß‡∏£‡πå: " + (tourObj.info?.name || "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå)");
  return true;
}

// ‡πÇ‡∏´‡∏•‡∏î template ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö
function loadTemplates() {
  const select = document.getElementById("templateSelect");
  select.innerHTML = `<option value="">-- ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Structure --</option>`;
  Object.keys(localStorage)
    .filter(k => k.startsWith("structure_template_"))
    .forEach(key => {
      const name = key.replace("structure_template_","");
      select.innerHTML += `<option value="${key}">${name}</option>`;
    });
}

function saveStructureTemp(key = "blind_structure_autosave") {
  const data = [];
  document.querySelectorAll("#structureTable tbody tr").forEach(row => {
    if (row.classList.contains("break")) {
      data.push({
        type: "break",
        note: row.querySelector('input[type="text"]')?.value || "",
        duration: row.querySelector('input[type="number"]')?.value || 10
      });
    } else {
      data.push({
        type: "level",
        sb: row.cells[1].querySelector("input").value,
        bb: row.cells[2].querySelector("input").value,
        ante: row.cells[3].querySelector("input").value,
        duration: row.cells[4].querySelector("input").value
      });
    }
  });
  // localStorage.setItem (replaced)(key, JSON.stringify(data));
}
function loadStructureFromData(data) {
  const tbody = document.querySelector("#structureTable tbody");
  tbody.innerHTML = "";
  levelCounter = 1;
  breakCounter = 1;
  data.forEach(item => {
    if (item.type === "break") {
      const row = document.createElement("tr");
      row.classList.add("break");
      row.innerHTML = `
        <td></td>
        <td colspan="3"><input type="text" placeholder="Break Note" value="${item.note || ''}"></td>
        <td><input type="number" value="${item.duration || 10}"></td>
        <td class="time"></td>
        <td><span class="delete-btn" onclick="deleteRow(this)">üóë</span></td>
      `;
      tbody.appendChild(row);
    } else {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>Level ${levelCounter++}</td>
        <td><input type="text" value="${item.sb || ''}"></td>
        <td><input type="text" value="${item.bb || ''}"></td>
        <td><input type="text" value="${item.ante || ''}"></td>
        <td><input type="number" value="${item.duration || 10}"></td>
        <td class="time"></td>
        <td>
          <span class="delete-btn" onclick="deleteRow(this)">üóë</span>
          <button class="insert-break-btn" onclick="insertBreakAfter(this)">+Break</button>
        </td>
      `;
      tbody.appendChild(row);
    }
  });
  attachFormatHandlers();
  updateTimeColumn();
}


function loadStructureTemp(key = "blind_structure_autosave") {
  const data = JSON.parse(// localStorage.getItem (replaced)(key) || "[]");
  const tbody = document.querySelector("#structureTable tbody");
  tbody.innerHTML = "";
  levelCounter = 1;
  breakCounter = 1;
  data.forEach(item => {
    if (item.type === "break") {
      const row = document.createElement("tr");
      row.classList.add("break");
      row.innerHTML = `
        <td></td>
        <td colspan="3"><input type="text" placeholder="Break Note" value="${item.note || ''}"></td>
        <td><input type="number" value="${item.duration || 10}"></td>
        <td class="time"></td>
        <td><span class="delete-btn" onclick="deleteRow(this)">üóë</span></td>
      `;
      tbody.appendChild(row);
    } else {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>Level ${levelCounter++}</td>
        <td><input type="text" value="${item.sb || ''}"></td>
        <td><input type="text" value="${item.bb || ''}"></td>
        <td><input type="text" value="${item.ante || ''}"></td>
        <td><input type="number" value="${item.duration || 10}"></td>
        <td class="time"></td>
        <td>
          <span class="delete-btn" onclick="deleteRow(this)">üóë</span>
          <button class="insert-break-btn" onclick="insertBreakAfter(this)">+Break</button>
        </td>
      `;
      tbody.appendChild(row);
    }
  });
  attachFormatHandlers();
  updateTimeColumn();
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏±‡∏ß‡∏£‡πå (object ‡∏ó‡∏±‡∏ß‡∏£‡πå)
function saveToTournament() {
  if (!currentTourKey || !// localStorage.getItem (replaced)(currentTourKey)) return;
  saveStructureTemp();
  const data = JSON.parse(// localStorage.getItem (replaced)("blind_structure_autosave") || "[]");
  const obj = JSON.parse(// localStorage.getItem (replaced)(currentTourKey));
  obj.blindStructure = data;
  // localStorage.setItem (replaced)(currentTourKey, JSON.stringify(obj));
  localStorage.removeItem('blind_structure_autosave');
  showSavedModal();  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å popup ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
}



function saveAsTemplate() {
  saveStructureTemp();
  const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Structure:");
  if (!name) return;
  const data = JSON.parse(// localStorage.getItem (replaced)("blind_structure_autosave") || "[]");
  // localStorage.setItem (replaced)("structure_template_" + name, JSON.stringify(data));
  loadTemplates();
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö Structure ‡πÅ‡∏•‡πâ‡∏ß: " + name);
}

function applyTemplate() {
  const key = document.getElementById("templateSelect").value;
  if (!key) return;
  if (!confirm("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà)")) return;
  loadStructureTemp(key);
  saveStructureTemp(); // autosave ‡∏ó‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°
}

function clearStructure() {
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á Blind Structure ‡∏ô‡∏µ‡πâ?")) return;
  // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Å‡∏±‡∏ö template)
  localStorage.removeItem("blind_structure_autosave");
  loadStructureTemp();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°-‡∏•‡∏ö-‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ñ‡∏ß (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
function addLevel() {
  const tbody = document.querySelector("#structureTable tbody");
  let firstDuration = "10";
  const firstRow = document.querySelector("#structureTable tbody tr:not(.break)");
  if (firstRow) {
    firstDuration = firstRow.cells[4].querySelector("input").value || "10";
  }
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>Level ${levelCounter++}</td>
    <td><input type="text"></td>
    <td><input type="text"></td>
    <td><input type="text"></td>
    <td><input type="number" value="${firstDuration}"></td>
    <td class="time"></td>
    <td>
      <span class="delete-btn" onclick="deleteRow(this)">üóë</span>
      <button class="insert-break-btn" onclick="insertBreakAfter(this)">+Break</button>
    </td>
  `;
  tbody.appendChild(row);
  saveStructureTemp();
  attachFormatHandlers();
  updateTimeColumn();
}


function insertBreakAfter(el) {
  const tr = el.closest("tr");
  const tbody = tr.parentNode;
  const idx = Array.prototype.indexOf.call(tbody.children, tr);

  // ‡∏´‡∏≤ duration ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å (default)
  let firstDuration = "10";
  const firstRow = document.querySelector("#structureTable tbody tr:not(.break)");
  if (firstRow) {
    firstDuration = firstRow.cells[4].querySelector("input").value || "10";
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß break ‡πÉ‡∏´‡∏°‡πà
  const row = document.createElement("tr");
  row.classList.add("break");
  row.innerHTML = `
    <td></td>
    <td colspan="3"><input type="text" placeholder="Break Note"></td>
    <td><input type="number" value="${firstDuration}"></td>
    <td class="time"></td>
    <td><span class="delete-btn" onclick="deleteRow(this)">üóë</span></td>
  `;
  // ‡πÅ‡∏ó‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á tr
  if (tbody.children[idx + 1]) {
    tbody.insertBefore(row, tbody.children[idx + 1]);
  } else {
    tbody.appendChild(row);
  }
  saveStructureTemp();
  renumber();
  attachFormatHandlers();
  updateTimeColumn();
}

function deleteRow(el) {
  el.closest("tr").remove();
  renumber();
  saveStructureTemp();
  updateTimeColumn();
}
function renumber() {
  levelCounter = 1;
  breakCounter = 1;
  document.querySelectorAll("#structureTable tbody tr").forEach(row => {
    if (row.classList.contains("break")) {
      row.cells[0].textContent = `Break ${breakCounter++}`;
    } else {
      row.cells[0].textContent = `Level ${levelCounter++}`;
    }
  });
}
function formatK(value) {
  const num = parseFloat(value);
  if (isNaN(num)) return value;
  if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
  return num.toString();
}
function parseK(input) {
  const val = input.toLowerCase().trim();
  if (val === '') return '';
  if (val.endsWith('k')) return parseFloat(val) * 1000;
  return parseFloat(val);
}
function attachFormatHandlers() {
  const rows = document.querySelectorAll('#structureTable tbody tr');
  rows.forEach((row, rowIndex) => {
    if (!row.classList.contains("break")) {
      const sbInput = row.cells[1].querySelector("input");
      const bbInput = row.cells[2].querySelector("input");
      const anteInput = row.cells[3].querySelector("input");
      const durationInput = row.cells[4].querySelector("input");

      // === Auto-fill ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å SB ===
      if (sbInput) {
        sbInput.onblur = function () {
          const sb = parseK(sbInput.value);
          if (!isNaN(sb)) {
            sbInput.value = formatK(sb);
            if (bbInput) bbInput.value = formatK(sb * 2);
            if (bbInput && anteInput) anteInput.value = formatK(sb * 2);
            // Auto-fill duration = duration ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏™‡∏°‡∏≠
            const firstRow = document.querySelector("#structureTable tbody tr:not(.break)");
            if (firstRow && durationInput && rowIndex !== 0) {
              const firstDuration = firstRow.cells[4].querySelector("input").value;
              if (firstDuration) durationInput.value = firstDuration;
            }
            saveStructureTemp();
            updateTimeColumn();
          }
        };
        sbInput.onfocus = function () {
          const parsed = parseK(sbInput.value);
          if (parsed !== '') sbInput.value = parsed;
        };
        sbInput.oninput = function () {
          saveStructureTemp();
          updateTimeColumn();
        };

        // Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà
        sbInput.onkeydown = function (e) {
          if (e.key === "Enter" && rowIndex === rows.length - 1) {
            addLevel();
            setTimeout(() => {
              const tbody = document.querySelector("#structureTable tbody");
              const newRow = tbody.children[tbody.children.length - 1];
              if (newRow) {
                const newSb = newRow.cells[1].querySelector("input");
                if (newSb) newSb.focus();
              }
            }, 100);
            e.preventDefault();
          }
        };
      }

      // ‡∏ä‡πà‡∏≠‡∏á BB, ANTE, DURATION
      [bbInput, anteInput, durationInput].forEach(input => {
        if (input) {
          input.onblur = function () {
            input.value = formatK(parseK(input.value));
            saveStructureTemp();
            updateTimeColumn();
          };
          input.onfocus = function () {
            const parsed = parseK(input.value);
            if (parsed !== '') input.value = parsed;
          };
          input.oninput = function () {
            saveStructureTemp();
            updateTimeColumn();
          };
          input.onkeydown = function (e) {
            if (e.key === "Enter" && rowIndex === rows.length - 1) {
              addLevel();
              setTimeout(() => {
                const tbody = document.querySelector("#structureTable tbody");
                const newRow = tbody.children[tbody.children.length - 1];
                if (newRow) {
                  const newSb = newRow.cells[1].querySelector("input");
                  if (newSb) newSb.focus();
                }
              }, 100);
              e.preventDefault();
            }
          };
        }
      });
    } else {
      // BREAK ROW (‡∏ä‡πà‡∏≠‡∏á note, duration)
      const noteInput = row.querySelector('input[type="text"]');
      const durationInput = row.querySelector('input[type="number"]');
      if (durationInput) {
        durationInput.onfocus = function () {
          if (!durationInput.value || durationInput.value === "0") {
            const firstRow = document.querySelector("#structureTable tbody tr:not(.break)");
            const firstDuration = firstRow ? firstRow.cells[4].querySelector("input").value : "10";
            durationInput.value = firstDuration || "10";
          }
        };
        durationInput.onblur = function () {
          saveStructureTemp();
          updateTimeColumn();
        };
        durationInput.oninput = function () {
          saveStructureTemp();
          updateTimeColumn();
        };
      }
      if (noteInput) {
        noteInput.onfocus = function () {
          if (durationInput && (!durationInput.value || durationInput.value === "0")) {
            const firstRow = document.querySelector("#structureTable tbody tr:not(.break)");
            const firstDuration = firstRow ? firstRow.cells[4].querySelector("input").value : "10";
            durationInput.value = firstDuration || "10";
          }
        };
        noteInput.oninput = function () {
          saveStructureTemp();
          updateTimeColumn();
        };
      }
    }
  });
}
function updateInputsAfterAdd() {
  attachFormatHandlers();
  updateTimeColumn();
}
// ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
function updateTimeColumn() {
  let sum = 0;
  document.querySelectorAll("#structureTable tbody tr").forEach(row => {
    const duration = parseInt(row.querySelector('input[type="number"]')?.value) || 0;
    sum += duration;
    const h = Math.floor(sum / 60).toString();
    const m = (sum % 60).toString().padStart(2, '0');
    if (row.cells[5]) row.cells[5].textContent = `${h}:${m}`;
  });
}
// ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
window.addEventListener("DOMContentLoaded", () => {
  if (!checkTourSelected()) return;
  loadTemplates();
  // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å object ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ temp ‡∏Å‡πà‡∏≠‡∏ô
  const tourObj = JSON.parse(// localStorage.getItem (replaced)(currentTourKey));
  if (tourObj.blindStructure && Array.isArray(tourObj.blindStructure)) {
    loadStructureFromData(tourObj.blindStructure);
  } else {
    loadStructureTemp(); // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏±‡∏ß‡∏£‡πå ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å temp (‡∏Å‡∏£‡∏ì‡∏µ template ‡πÉ‡∏´‡∏°‡πà/‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏´‡∏°‡πà)
  }
  attachFormatHandlers();
  updateTimeColumn();
});
function showDeleteTemplateDialog() {
  // ‡∏î‡∏∂‡∏á template key ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const keys = Object.keys(localStorage).filter(k=>k.startsWith("structure_template_"));
  const select = document.getElementById('deleteTemplateSelect');
  select.innerHTML = '';
  if (keys.length === 0) {
    select.innerHTML = '<option value="">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏ö)</option>';
  } else {
    keys.forEach(k => {
      const name = k.replace('structure_template_','');
      select.innerHTML += `<option value="${k}">${name}</option>`;
    });
  }
  document.getElementById('deleteTemplateModal').style.display = 'flex';
}
function closeDeleteTemplateModal() {
  document.getElementById('deleteTemplateModal').style.display = 'none';
}
function deleteSelectedTemplate() {
  const select = document.getElementById('deleteTemplateSelect');
  const key = select.value;
  if (!key) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö');
  if (!confirm('‡∏•‡∏ö‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ?')) return;
  localStorage.removeItem(key);
  closeDeleteTemplateModal();
  loadTemplates();
  alert('‡∏•‡∏ö‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
}


</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqd20lb2fQSMjqsSmzUXXgQFhBNC8sB9g",
    authDomain: "luxutour-63450.firebaseapp.com",
    projectId: "luxutour-63450",
    storageBucket: "luxutour-63450.appspot.com",
    messagingSenderId: "349190270077",
    appId: "1:349190270077:web:c52b936bdc2f06c7db1514",
    measurementId: "G-1F45DPS42M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const tourKey = urlParams.get("tourKey") || "defaultTour";

  function renderBlindStructure(data) {
    const tbody = document.querySelector("#blindTable tbody");
    tbody.innerHTML = "";
    data.forEach((item, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" value="${item.SB || ""}" /></td>
        <td><input type="text" value="${item.BB || ""}" /></td>
        <td><input type="text" value="${item.Ante || ""}" /></td>
        <td><input type="text" value="${item.Note || ""}" /></td>
        <td><input type="text" value="${item.Time || ""}" /></td>
      `;
      tbody.appendChild(row);
    });
  }

  async function saveStructureToFirestore() {
    const rows = document.querySelectorAll("#blindTable tbody tr");
    const structure = Array.from(rows).map(row => {
      const inputs = row.querySelectorAll("input");
      return {
        SB: inputs[0].value,
        BB: inputs[1].value,
        Ante: inputs[2].value,
        Note: inputs[3].value,
        Time: inputs[4].value
      };
    });
    await setDoc(doc(db, "blindStructures", tourKey), { structure });
    alert("Saved to Firestore.");
  }

  window.saveStructure = saveStructureToFirestore;

  document.addEventListener("DOMContentLoaded", () => {
    const ref = doc(db, "blindStructures", tourKey);
    onSnapshot(ref, (docSnap) => {
      const data = docSnap.data();
      if (data && data.structure && data.structure.length > 0) {
        renderBlindStructure(data.structure);
      }
    });

    // fallback: if no data after 1s, show blank row
    setTimeout(() => {
      const tbody = document.querySelector("#blindTable tbody");
      if (!tbody || tbody.children.length === 0) {
        if (typeof addRow === "function") addRow();
      }
    }, 1000);
  });
</script>

<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  }
});
</script>

<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  const tourRef = db.collection("tournaments").doc(tourKey);

  // Load blind structure
  tourRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      const structure = data.structure || [];
      const tbody = document.getElementById("blindTableBody");
      if (tbody) {
        tbody.innerHTML = "";
        structure.forEach((level, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td><input value="${level.sb || ""}" /></td>
            <td><input value="${level.bb || ""}" /></td>
            <td><input value="${level.ante || ""}" /></td>
            <td><input value="${level.note || ""}" /></td>
          `;
          tbody.appendChild(row);
        });
      }
    }
  });

  // Save structure
  function saveBlindStructure() {
    const rows = document.querySelectorAll("#blindTableBody tr");
    const structure = [];
    rows.forEach(row => {
      const cells = row.querySelectorAll("input");
      structure.push({
        sb: cells[0].value,
        bb: cells[1].value,
        ante: cells[2].value,
        note: cells[3].value,
      });
    });
    tourRef.update({ structure }).then(() => {
      alert("Blind structure saved!");
    });
  }
</script>


<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  const tourRef = db.collection("tournaments").doc(tourKey);

  function renderStructure(structure) {
    const tbody = document.getElementById("blindTableBody");
    tbody.innerHTML = "";
    structure.forEach((level, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${index + 1}</td>
        <td><input data-idx="${index}" data-field="sb" value="${level.sb || ""}" /></td>
        <td><input data-idx="${index}" data-field="bb" value="${level.bb || ""}" /></td>
        <td><input data-idx="${index}" data-field="ante" value="${level.ante || ""}" /></td>
        <td><input data-idx="${index}" data-field="note" value="${level.note || ""}" /></td>
      `;
      tbody.appendChild(row);
    });

    // Bind inputs to auto-update Firestore
    tbody.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", () => {
        const index = parseInt(input.dataset.idx);
        const field = input.dataset.field;
        structure[index][field] = input.value;
        tourRef.update({ structure });
      });
    });
  }

  // Load structure in real time
  tourRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      const structure = data.structure || [];
      renderStructure(structure);
    }
  });
</script>

</body>
</html>
