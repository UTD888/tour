<!DOCTYPE html>
<html lang="th">
<head>

<!-- Firebase SDK v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup Poker Tournament</title>
  <style>
    button:disabled {
  opacity: 0.4 !important;
  cursor: not-allowed !important;
  filter: grayscale(50%);
}

    .modal-bg {
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.55);
  display: flex;
  align-items: center;
  justify-content: center;
}

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      margin: 0;
      padding: 20px;
      color: #ffffff;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      color: #ffffff;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }
    .main-container {
      display: flex;
      gap: 35px;
      align-items: flex-start;
      justify-content: center;
      min-height: 600px;
    }
    .section-left {
      width: 30%;
      min-width: 320px;
      background: #1f1f1f;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(255,255,255,0.08);
    }
    .section-right {
      width: 70%;
      min-width: 440px;
      background: #181a1f;
      padding: 24px 18px;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(0,0,0,0.08);
      min-height: 500px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .player-box {
      max-width: 700px;
      margin: 0 auto;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.4);
      padding: 24px;
    }
    .player-box h2 {
      margin-top: 0;
      color: #00bfff;
      text-align: center;
    }
    .player-input {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
    }
    .player-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 6px;
      background: #2a2a2a;
      color: #fff;
      font-size: 16px;
    }
    .player-input button {
      padding: 8px 18px;
      border-radius: 6px;
      border: none;
      background: #28a745;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .player-input .reset-btn {
      background: #6c757d;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    th, td {
      border: 1px solid #444;
      padding: 7px 4px;
      text-align: center;
    }
    th {
      background: #222;
      color: #00bfff;
    }
    tr:nth-child(even) { background: #242424; }
    button.small {
      padding: 2px 7px;
      border-radius: 5px;
      font-size: 13px;
    }
    .remove-btn { background: #dc3545; color: #fff; }
    .rebuy-btn { background: #17a2b8; color: #fff; }
    .addon-btn { background: #ffc107; color: #222; }
    label {
      display: block;
      margin-top: 15px;
      color: #eeeeee;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 1em;
      border: 1px solid #555;
      border-radius: 6px;
      background: #2b2b2b;
      color: #ffffff;
    }
    .hidden {
      display: none;
    }
    .btn {
      padding: 8px;
      font-size: 1.1em;
      background-color: #ffffff;
      color: #121212;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }
    .btn:hover {
      background-color: #dddddd;
    }
    .logo-wrapper {
      text-align: center;
      margin-bottom: 10px;
    }
    .logo {
      height: 100px;
      object-fit: contain;
    }
    input:disabled,
    select:disabled {
      background-color: #444;
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }
    @media (max-width: 900px) {
      .main-container { flex-direction: column; gap: 18px; }
      .section-left, .section-right { width: 100%; min-width: 0; }
    }
    .modal-btn {
  padding: 7px 10px;
  font-size: 1em;
  margin-bottom: 7px;
  display: block;
  width: 100%;
  background: #fff;
  color: #222;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
}
.modal-btn:hover {
  background: #e6e6e6;
}
.delete-btn {
  background: #dc3545 !important;
  color: #fff !important;
}
    .modal-content {
  background: #232323;
  padding: 16px 14px;
  border-radius: 12px;
  min-width: 180px;
  max-width: 320px;
  box-sizing: border-box;
  width: 100%;
}
@media (max-width: 500px) {
  .modal-content {
    min-width: 0;
    max-width: 95vw;
    padding: 10px 4vw;
  }
}
.player-box.bounty-mode {
  max-width: 960px;
  min-width: 720px;
  transition: max-width 0.25s;
}
    .player-box {
  max-width: 1100px;
  min-width: 600px;
  margin: 0 auto;
  background: #222;
  border-radius: 10px;
  box-shadow: 0 0 12px rgba(0,0,0,0.4);
  padding: 24px;
}




  </style>

<!-- Firebase SDK compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="firebase-config.js"></script>

</head>
<body>

<script>
  firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
      window.location.href = "login.html";
    }
  });
  function logout() {
    firebase.auth().signOut().then(() => {
      window.location.href = "login.html";
    });
  }
</script>

  
<!-- Modal Load Tour -->
<div id="loadTourModal" class="hidden modal-bg">
  <div class="modal-content">
    <h3 style="color:#00bfff;margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏≤‡πÄ‡∏°‡∏ô‡∏ï‡πå</h3>
    <div id="loadTourList"></div>
    <button class="btn" style="margin-top:18px;" onclick="closeLoadTourModal()">Cancel</button>
  </div>
</div>
<!-- Modal Delete Tour -->
<div id="deleteTourModal" class="hidden modal-bg">
  <div class="modal-content">
    <h3 style="color:#ff4444;margin-top:0;">‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏≤‡πÄ‡∏°‡∏ô‡∏ï‡πå</h3>
    <div id="deleteTourList"></div>
    <button class="btn" style="margin-top:18px;" onclick="closeDeleteTourModal()">Cancel</button>
  </div>
</div>


  <h1>Setup Poker Tournament</h1>
  <div class="main-container">
    <div class="section-left">
      <!-- Start Tour Box -->
      <div id="tourStateBox" style="margin-bottom:16px;"></div>
      <div id="startTourBox">
        <button class="btn" onclick="showCreateTour()">‚ûï Create Tour</button>
        <button class="btn" onclick="showLoadTour()">üìÇ Load</button>
        <button class="btn" onclick="showDeleteTour()">üóëÔ∏è Delete</button>
      </div>
      <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ß‡∏£‡πå -->
      <div id="tourInfoEditBox" class="hidden">
        <div class="logo-wrapper">
          <img src="luxu-logo.png" alt="Luxu Logo" class="logo">
        </div>
        <h2 style="color:#007bff; margin-top:0;">Create Tournament</h2>
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏≤‡πÄ‡∏°‡∏ô‡∏ï‡πå *</label>
        <input type="text" id="tournamentName" required>
        <div style="display: flex; gap: 10px;">
          <div style="flex: 1;">
            <label>Tournament Type *</label>
            <select id="tournamentType" required>
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
              <option value="Normal">Normal</option>
              <option value="Bounty">Bounty</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label>Guarantee</label>
            <input type="text" id="guarantee" placeholder="(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
          </div>
        </div>
        <label>‡∏ß‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô *</label>
        <input type="date" id="tournamentDate" required>
        <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô *</label>
        <input type="time" id="tournamentTime" required>
        <div style="display: flex; gap: 10px;">
          <div style="flex: 1;">
            <label>Buy-in (‡∏ö‡∏≤‡∏ó) *</label>
            <input type="number" id="buyIn" required>
          </div>
          <div style="flex: 1;">
            <label>Re-buy</label>
            <input type="number" id="rebuy">
          </div>
        </div>
        <label>Allow Add-on</label>
        <select id="allowAddon" onchange="toggleAddonStack()">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
        <div id="addonBox" class="hidden">
          <label>Add-on *</label>
          <input type="number" id="addon">
        </div>
        <label>Starting Stack *</label>
        <input type="number" id="startingStack" required oninput="updateAddonStack()">
        <div id="addonStackBox" class="hidden">
          <label>Add-on Stack</label>
          <input type="number" id="addonStack">
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; justify-content: center;">
          <button class="btn" onclick="saveTourInfoEdit()">OK</button>
          <button class="btn" onclick="cancelEditTourInfo()">Cancel</button>
        </div>
      </div>
      <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå -->
      <div id="tourInfoBox" class="hidden">
        <div class="logo-wrapper">
          <img src="luxu-logo.png" alt="Luxu Logo" class="logo">
        </div>
        <h2 style="color:#007bff; margin-top:0;">Tournament Info</h2>
        <div id="tourInfoFields"></div>
  <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; justify-content: center;">
  <button class="btn" onclick="openDisplay()">üì∫ Display</button>
  <button class="btn" onclick="window.open('blind-structure.html', '_blank')">üìù Structure</button>
  <button onclick="window.open('PrizePool.html?tour=' + encodeURIComponent(currentTourKey), '_blank')">
  üèÜ Prize Pool
</button>
  <button class="btn" onclick="editTourInfo()">‚úèÔ∏è Edit</button>
  <button class="btn" onclick="finishTour()">Finish / Export</button>
  <button class="btn" onclick="backToStartTour()">Back</button>
</div>

      </div>
    </div>
    <div class="section-right">
      <div class="player-box" id="playerBox" style="display:none;">
        <h2>Players Management</h2>
        <div class="player-input">
          <input type="text" id="entryName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
          <button id="addEntryBtn">+ Entry</button>
          <button class="reset-btn" id="resetEntriesBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Status</th>
              <th>Re-buy</th>
              <th>Add-on</th>
              <th>‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="entryList"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // --- Auto-load Tour ‡∏´‡∏•‡∏±‡∏á refresh ---
window.onload = function() {
  const key = localStorage.getItem('currentTourKey');
  if (key && localStorage.getItem(key)) {
    currentTourKey = key;
    let tourObj;
    try { tourObj = JSON.parse(localStorage.getItem(key)); } catch { tourObj = null; }
    if (!tourObj || !tourObj.info) {
      document.getElementById('tourInfoBox').classList.add('hidden');
      document.getElementById('playerBox').style.display = 'none';
      document.getElementById('startTourBox').classList.remove('hidden');
      currentTourKey = null;
      return;
    }
    renderTourInfoBox(tourObj.info);
    document.getElementById('tourInfoBox').classList.remove('hidden');
    document.getElementById('playerBox').style.display = '';
    document.getElementById('startTourBox').classList.add('hidden');
    document.getElementById('tourInfoEditBox').classList.add('hidden');
    renderEntries();
  } else {
    // Default: show Start Tour
    document.getElementById('tourInfoBox').classList.add('hidden');
    document.getElementById('playerBox').style.display = 'none';
    document.getElementById('startTourBox').classList.remove('hidden');
    document.getElementById('tourInfoEditBox').classList.add('hidden');
    currentTourKey = null;
  }
}


    let currentTourKey = null;
    function showCreateTour() {
      document.getElementById('startTourBox').classList.add('hidden');
      document.getElementById('tourInfoEditBox').classList.remove('hidden');
      document.getElementById('tourInfoBox').classList.add('hidden');
      document.getElementById('playerBox').style.display = 'none';
      // clear form
      document.getElementById('tournamentName').value = '';
      document.getElementById('tournamentType').value = '';
      document.getElementById('guarantee').value = '';
      document.getElementById('tournamentDate').value = '';
      document.getElementById('tournamentTime').value = '';
      document.getElementById('buyIn').value = '';
      document.getElementById('rebuy').value = '';
      document.getElementById('allowAddon').value = 'No';
      document.getElementById('addon').value = '';
      document.getElementById('startingStack').value = '';
      document.getElementById('addonStack').value = '';
      document.getElementById('addonBox').classList.add('hidden');
      document.getElementById('addonStackBox').classList.add('hidden');
    }

    function saveTourInfoEdit() {
  const name = document.getElementById('tournamentName').value.trim();
  const type = document.getElementById('tournamentType').value;
  if (!name || !type) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡∏ß‡∏£‡πå");
  const key = "tour_" + name.replace(/\s+/g, '_');
  currentTourKey = key;
  localStorage.setItem('currentTourKey', currentTourKey);

  const info = {
    name,
    type,
    guarantee: document.getElementById('guarantee').value,
    date: document.getElementById('tournamentDate').value,
    time: document.getElementById('tournamentTime').value,
    buyIn: document.getElementById('buyIn').value,
    rebuy: document.getElementById('rebuy').value,
    allowAddon: document.getElementById('allowAddon').value,
    addon: document.getElementById('addon').value,
    startingStack: document.getElementById('startingStack').value,
    addonStack: document.getElementById('addonStack').value
  };

  // --- ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à ---
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ key ‡πÄ‡∏î‡∏¥‡∏° players ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô, ‡∏ñ‡πâ‡∏≤ key ‡πÉ‡∏´‡∏°‡πà players ‡πÄ‡∏õ‡πá‡∏ô []
  let tourObj = JSON.parse(localStorage.getItem(key));
  if (!tourObj) {
    tourObj = { info, players: [] };
  } else {
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï info ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    tourObj.info = info;
  }
  localStorage.setItem(key, JSON.stringify(tourObj));

  document.getElementById('tourInfoEditBox').classList.add('hidden');
  renderTourInfoBox(info);
  document.getElementById('tourInfoBox').classList.remove('hidden');
  document.getElementById('playerBox').style.display = '';
  document.getElementById('tournamentName').disabled = false;
  document.getElementById('tournamentType').disabled = false;
  renderEntries();
}



    function cancelEditTourInfo() {
  document.getElementById('tourInfoEditBox').classList.add('hidden');
  document.getElementById('startTourBox').classList.remove('hidden');
  document.getElementById('playerBox').style.display = 'none';
  document.getElementById('tournamentName').disabled = false;
  document.getElementById('tournamentType').disabled = false;
}


    function renderTourInfoBox(info) {
      let html = '';
      html += `<div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏≤‡πÄ‡∏°‡∏ô‡∏ï‡πå:</b> ${info.name}</div>`;
      html += `<div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${info.type}</div>`;
      html += `<div><b>Guarantee:</b> ${info.guarantee || '-'}</div>`;
      html += `<div><b>‡∏ß‡∏±‡∏ô‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô:</b> ${info.date || '-'}</div>`;
      html += `<div><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${info.time || '-'}</div>`;
      html += `<div><b>Buy-in:</b> ${info.buyIn || '-'}</div>`;
      html += `<div><b>Re-buy:</b> ${info.rebuy || '-'}</div>`;
      html += `<div><b>Add-on:</b> ${info.allowAddon === 'Yes' ? info.addon : '-'}</div>`;
      html += `<div><b>Starting Stack:</b> ${info.startingStack || '-'}</div>`;
      html += `<div><b>Add-on Stack:</b> ${info.addonStack || '-'}</div>`;
      document.getElementById('tourInfoFields').innerHTML = html;
      renderTourStateBox();
    }

    function backToStartTour() {
      currentTourKey = null;
      document.getElementById('tourInfoBox').classList.add('hidden');
      document.getElementById('playerBox').style.display = 'none';
      document.getElementById('startTourBox').classList.remove('hidden');
      localStorage.removeItem('currentTourKey');

    }

    // ---- Players Management ----
    function getData() {
      if (!currentTourKey) return { players: [] };
      return JSON.parse(localStorage.getItem(currentTourKey) || '{"players":[]}');
    }
    function saveData(data) {
      if (!currentTourKey) return;
      localStorage.setItem(currentTourKey, JSON.stringify(data));
    }
    function renderEntries() {      
  const data = getData();
  const entries = data.players || [];
  const list = document.getElementById('entryList');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö type
  const info = (localStorage.getItem(currentTourKey) ? JSON.parse(localStorage.getItem(currentTourKey)).info : {});
  const type = info.type || 'Normal';

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô thead
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô thead
const playerBox = document.getElementById('playerBox');
if (type === "Bounty") {
  playerBox.classList.add('bounty-mode');
} else {
  playerBox.classList.remove('bounty-mode');
}

  const thead = document.querySelector('.player-box table thead tr');
if (type === "Bounty") {
  thead.innerHTML = `
    <th>#</th>
    <th>Name</th>
    <th>Bounty</th>
    <th>Earning</th>
    <th>Status</th>
    <th>KO</th>
    <th>Re-buy</th>
    <th>Add-on</th>
    <th>‡∏•‡∏ö</th>
  `;
} else {
  thead.innerHTML = `
    <th>#</th>
    <th>Name</th>
    <th>Status</th>
    <th>Re-buy</th>
    <th>Add-on</th>
    <th>‡∏•‡∏ö</th>
  `;
}


  // render tbody
  list.innerHTML = entries.map((player, i) => {
  const status = player.status || (type === 'Bounty' ? 'Alive' : 'Active');
  const rebuyUsed = player.rebuyUsed || 0;
  const addonUsed = player.addonUsed || false;

  if (type === "Bounty") {
  return `
    <tr>
      <td>${i + 1}</td>
      <td>${player.name}</td>
      <td>${player.bounty || '-'}</td>
      <td>${player.earning || '0'}</td>
      <td>
        <span style="color:${status === 'Alive' ? '#28a745' : '#dc3545'};font-weight:bold;">
          ${status}
        </span>
      </td>
      <td>
  <button class="small" style="background:#00bcd4;color:#fff;" onclick="openKOPopup(${i})" ${status !== 'Alive' ? 'disabled' : ''}>
    KO (${player.ko || 0})
  </button>
</td>

      </td>
      <td>
        <button class="small rebuy-btn" onclick="handleRebuy(${i})" ${status !== 'Dead' ? 'disabled' : ''}>
          Re-buy ${rebuyUsed > 0 ? `(${rebuyUsed})` : ''}
        </button>
      </td>
      <td>
        <button class="small addon-btn" onclick="handleAddon(${i})" ${status!=='Alive' || addonUsed ? 'disabled' : ''}>
          Add-on ${addonUsed ? '<span style=\'color:green;\'>‚úî</span>' : ''}
        </button>
      </td>
      <td>
        <button class="small remove-btn" onclick="removeEntry(${i})">‚ùå</button>
      </td>
    </tr>
  `;
}
 else {
    // Normal
    return `
  <tr>
    <td>${i + 1}</td>
    <td>${player.name}</td>
    <td>
      <select onchange="updateStatus(${i}, this.value)" ${status!=='Active' ? 'disabled' : ''}>
        <option value="Active" ${status==='Active'?'selected':''}>Active</option>
        <option value="BUST" ${status==='BUST'?'selected':''}>BUST</option>
        <option value="OUT" ${status==='OUT'?'selected':''}>OUT</option>
      </select>
    </td>
    <td>
      <button class="small rebuy-btn"
        onclick="handleRebuy(${i})"
        ${status!=='BUST' ? 'disabled' : ''}>
        Re-buy ${rebuyUsed > 0 ? `(${rebuyUsed})` : ''}
      </button>
    </td>
    <td>
      <button class="small addon-btn"
        onclick="handleAddon(${i})"
        ${status!=='Active' || addonUsed ? 'disabled' : ''}>
        Add-on ${addonUsed ? '<span style=\'color:green;\'>‚úî</span>' : ''}
      </button>
    </td>
    <td>
      <button class="small remove-btn" onclick="removeEntry(${i})">‚ùå</button>
    </td>
  </tr>
`;

  }
}).join('');

      renderTourStateBox();
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï addEntryBtn ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö bounty property
document.getElementById('addEntryBtn').onclick = function () {
  const name = document.getElementById('entryName').value.trim();
  if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô');
  let data = getData();
  data.players = data.players || [];
  if (data.players.find(p => p.name === name)) return alert('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö type
  const info = (localStorage.getItem(currentTourKey) ? JSON.parse(localStorage.getItem(currentTourKey)).info : {});
  const type = info.type || 'Normal';
  let playerObj = { name, status: (type === "Bounty" ? "Alive" : "Active"), rebuyUsed: 0, addonUsed: false };

  if (type === "Bounty") {
    playerObj.bounty = info.buyIn ? Math.round(parseFloat(info.buyIn) / 4) : 0;
    playerObj.earning = 0;
    playerObj.ko = 0;
  }
  data.players.push(playerObj);
  saveData(data);
  renderEntries();
  document.getElementById('entryName').value = '';
};

    document.getElementById('resetEntriesBtn').onclick = function () {
  if (!confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞ KO Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
  let data = getData();
  data.players = [];
  saveData(data);
  localStorage.removeItem('koLog'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  renderEntries();
};

    window.handleRebuy = function(index) {
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Re-buy ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ?')) return;
  let data = getData();
  const info = (localStorage.getItem(currentTourKey) ? JSON.parse(localStorage.getItem(currentTourKey)).info : {});
  const type = info.type || 'Normal';
  if (type === "Bounty" && data.players[index].status === 'Dead') {
    data.players[index].rebuyUsed = (data.players[index].rebuyUsed || 0) + 1;
    data.players[index].status = 'Alive';
    // bounty ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤ buy-in/4 (‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°)
    data.players[index].bounty = info.buyIn ? Math.round(parseFloat(info.buyIn) / 4) : 0;
    // earning ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    saveData(data);
    renderEntries();
    return;
  }
  if (type !== "Bounty" && (data.players[index].status === 'BUST' || data.players[index].status === 'OUT')) {
    data.players[index].rebuyUsed = (data.players[index].rebuyUsed || 0) + 1;
    data.players[index].status = 'Active';
    saveData(data);
    renderEntries();
    return;
  }
};



  window.handleAddon = function(index) {
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Add-on ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ?')) return;
  let data = getData();
  const info = (localStorage.getItem(currentTourKey) ? JSON.parse(localStorage.getItem(currentTourKey)).info : {});
  const type = info.type || 'Normal';

  if (
    (type === "Bounty" && data.players[index].status !== 'Alive') ||
    (type !== "Bounty" && data.players[index].status !== 'Active') ||
    data.players[index].addonUsed
  ) return;

  data.players[index].addonUsed = true;
  saveData(data);
  renderEntries();
};


window.removeEntry = function(index) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  let data = getData();
  data.players.splice(index, 1);
  saveData(data);
  renderEntries();
};

window.updateStatus = function(index, value) {
  let data = getData();
  data.players[index].status = value;
  saveData(data);
  renderEntries();
};
function toggleAddonStack() {
  let allowAddon = document.getElementById('allowAddon').value;
  document.getElementById('addonBox').classList.toggle('hidden', allowAddon !== 'Yes');
  document.getElementById('addonStackBox').classList.toggle('hidden', allowAddon !== 'Yes');
}
function updateAddonStack() {
  let allowAddon = document.getElementById('allowAddon').value;
  let starting = parseFloat(document.getElementById('startingStack').value || 0);
  if (allowAddon === 'Yes' && starting > 0) {
    document.getElementById('addonStack').value = Math.round(starting * 1.5);
  } else {
    document.getElementById('addonStack').value = '';
  }
}

function editTourInfo() {
  if (!currentTourKey) return;
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
  const info = JSON.parse(localStorage.getItem(currentTourKey)).info;
  // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById('tournamentName').value = info.name;
  document.getElementById('tournamentType').value = info.type;
  document.getElementById('guarantee').value = info.guarantee;
  document.getElementById('tournamentDate').value = info.date;
  document.getElementById('tournamentTime').value = info.time;
  document.getElementById('buyIn').value = info.buyIn;
  document.getElementById('rebuy').value = info.rebuy;
  document.getElementById('allowAddon').value = info.allowAddon;
  document.getElementById('addon').value = info.addon;
  document.getElementById('startingStack').value = info.startingStack;
  document.getElementById('addonStack').value = info.addonStack;
  // ‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô addonBox, addonStackBox ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤
  toggleAddonStack();
  // input: ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡∏±‡∏ö type ‡∏ï‡πâ‡∏≠‡∏á disabled (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ)
  document.getElementById('tournamentName').disabled = true;
  document.getElementById('tournamentType').disabled = true;

  document.getElementById('tourInfoBox').classList.add('hidden');
  document.getElementById('tourInfoEditBox').classList.remove('hidden');
  document.getElementById('startTourBox').classList.add('hidden');
  document.getElementById('playerBox').style.display = '';
}

function finishTour() {
  if (!currentTourKey) return;
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 'Finish/Export' ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ?\n‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö")) return;
  localStorage.removeItem(currentTourKey);
  localStorage.removeItem(currentTourKey + '_prizeSettings');

  // 1. Export JSON ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
  const tourObj = JSON.parse(localStorage.getItem(currentTourKey));
  const fileName = `${tourObj.info.name}_${tourObj.info.type}.json`;
  const fileData = JSON.stringify(tourObj, null, 2);
  const blob = new Blob([fileData], {type: 'application/json'});
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  setTimeout(() => {
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }, 100);

  // 2. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ (‡πÅ‡∏•‡∏∞ koLog ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô bounty)
  localStorage.removeItem(currentTourKey);
  localStorage.removeItem(currentTourKey + '_prizeSettings');

  if (tourObj.info.type === "Bounty") localStorage.removeItem('koLog');
  localStorage.removeItem('currentTourKey');

  // 3. ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
  currentTourKey = null;
  document.getElementById('tourInfoBox').classList.add('hidden');
  document.getElementById('playerBox').style.display = 'none';
  document.getElementById('startTourBox').classList.remove('hidden');
  alert("‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞ export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
  if (tourObj.info.type === "Bounty") {
  const koLog = localStorage.getItem('koLog');
  if (koLog) {
    const blobLog = new Blob([koLog], {type: 'application/json'});
    const urlLog = URL.createObjectURL(blobLog);
    const linkLog = document.createElement('a');
    linkLog.href = urlLog;
    linkLog.download = `${tourObj.info.name}_KOlog.json`;
    document.body.appendChild(linkLog);
    linkLog.click();
    setTimeout(() => {
      document.body.removeChild(linkLog);
      URL.revokeObjectURL(urlLog);
    }, 100);
  }
  localStorage.removeItem('koLog');
}

}

function showLoadTour() {
  let tourKeys = Object.keys(localStorage)
    .filter(k => k.startsWith('tour_') && !k.endsWith('_prizeSettings')); // <--- ‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ!
  let html = '';
  if (tourKeys.length === 0) {
    html = '<div style="color:#eee;padding:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>';
  } else {
    html = tourKeys.map(key => {
      let t;
      try { t = JSON.parse(localStorage.getItem(key)); } catch { t = null; }
      const name = (t && t.info && t.info.name) ? t.info.name : key.replace(/^tour_/, '');
      return `<button class="modal-btn" onclick="selectLoadedTour('${key}')">${name}</button>`;
    }).join('');
  }
  document.getElementById('loadTourList').innerHTML = html;
  document.getElementById('loadTourModal').classList.remove('hidden');
}


function closeLoadTourModal() {
  document.getElementById('loadTourModal').classList.add('hidden');
}
function selectLoadedTour(key) {
  currentTourKey = key;
  localStorage.setItem('currentTourKey', currentTourKey);
  let tourObj;
  try { tourObj = JSON.parse(localStorage.getItem(key)); } catch { tourObj = null; }
  if (!tourObj || !tourObj.info) {
    alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); 
    return;
  }
  renderTourInfoBox(tourObj.info);
  document.getElementById('tourInfoBox').classList.remove('hidden');
  document.getElementById('playerBox').style.display = '';
  document.getElementById('startTourBox').classList.add('hidden');
  document.getElementById('tourInfoEditBox').classList.add('hidden');
  document.getElementById('loadTourModal').classList.add('hidden');
  renderEntries();
}


function showDeleteTour() {
  let tourKeys = Object.keys(localStorage)
    .filter(k => k.startsWith('tour_') && !k.endsWith('_prizeSettings')); // <--- ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
  let html = '';
  if (tourKeys.length === 0) {
    html = '<div style="color:#eee;padding:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>';
  } else {
    html = tourKeys.map(key => {
      let t;
      try { t = JSON.parse(localStorage.getItem(key)); } catch { t = null; }
      const name = (t && t.info && t.info.name) ? t.info.name : key.replace(/^tour_/, '');
      const type = (t && t.info && t.info.type) ? t.info.type : '-';
      return `<button class="modal-btn delete-btn" onclick="confirmDeleteTour('${key}')">${name} (${type})</button>`;
    }).join('');
  }
  document.getElementById('deleteTourList').innerHTML = html;
  document.getElementById('deleteTourModal').classList.remove('hidden');
}

function closeDeleteTourModal() {
  document.getElementById('deleteTourModal').classList.add('hidden');
}
function confirmDeleteTour(key) {
  let t;
  try { t = JSON.parse(localStorage.getItem(key)); } catch { t = null; }
  const name = (t && t.info && t.info.name) ? t.info.name : key.replace(/^tour_/, '');
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå "${name}"?\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£)`)) return;
  localStorage.removeItem(key);
  localStorage.removeItem(key + '_prizeSettings');
  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
  if (localStorage.getItem('currentTourKey') === key) {
    localStorage.removeItem('currentTourKey');
    currentTourKey = null;
    document.getElementById('tourInfoBox').classList.add('hidden');
    document.getElementById('playerBox').style.display = 'none';
    document.getElementById('startTourBox').classList.remove('hidden');
    localStorage.removeItem('blind_structure_autosave');
  }
  closeDeleteTourModal();
}

    function renderTourStateBox() {
  if (!currentTourKey) {
    document.getElementById('tourStateBox').innerHTML = '';
    return;
  }
  const data = getData();
  const info = JSON.parse(localStorage.getItem(currentTourKey)).info;
  const players = data.players || [];
  const type = info.type || 'Normal';

  // Entry = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const entry = players.length;
  // ‡∏ô‡∏±‡∏ö Re-buy, Add-on
  let rebuy = 0;
  let addon = 0;
  players.forEach(p => {
    rebuy += p.rebuyUsed || 0;
    addon += p.addonUsed ? 1 : 0;
  });

  // Stack
  const startingStack = parseFloat(info.startingStack || 0);
  const addonStack = parseFloat(info.addonStack || 0);

  // Total stack = (entry + re-buy) * startingStack + (add-on * addonStack)
  const totalStack = (entry + rebuy) * startingStack + addon * addonStack;

  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô Alive (bounty) ‡∏´‡∏£‡∏∑‡∏≠ Active (normal)
  let alive = 0;
  let label = '';
  if (type === 'Bounty') {
    alive = players.filter(p => (p.status === 'Alive')).length;
    label = 'Alive';
  } else {
    alive = players.filter(p => (p.status === 'Active')).length;
    label = 'Active';
  }

  // ‡∏™‡∏π‡∏ï‡∏£ Average Stack ‡πÉ‡∏´‡∏°‡πà
  const avgStack = alive > 0 ? Math.round(totalStack / alive) : 0;

  // Prize pool & bounty pool
  const buyIn = parseFloat(info.buyIn || 0);
  const reBuy = parseFloat(info.rebuy || 0);
  const addOn = parseFloat(info.addon || 0);
  let prizePool = 0, bountyPool = 0;
  if (type === 'Bounty') {
  prizePool = ((buyIn/2) * entry) + ((reBuy/2) * rebuy) + (addOn * addon);
  bountyPool = ((buyIn/2) * entry) + ((reBuy/2) * rebuy);
} else {
  prizePool = (buyIn * entry) + (reBuy * rebuy) + (addOn * addon);
  bountyPool = 0;
}


  let html = `
    <div style="font-size:18px;font-weight:bold;margin-bottom:2px;">
      <span style="color:#00bfff;">${info.name || '-'}</span>
    </div>
    <div style="font-size:15px;line-height:1.6;">
      <b>Entries:</b> ${entry} &nbsp; | &nbsp; 
      <b>Re-buy:</b> ${rebuy} &nbsp; | &nbsp; 
      <b>Add-on:</b> ${addon}<br>
      <b>Total Stack:</b> ${totalStack.toLocaleString()} &nbsp; | &nbsp; 
      <b>Average Stack:</b> ${avgStack.toLocaleString()} <span style="font-size:13px;opacity:0.7;">(${label} = ${alive})</span><br>
      <b>Prize Pool:</b> ${prizePool.toLocaleString()} ‡∏ö‡∏≤‡∏ó
      ${type === 'Bounty'
        ? `<br><b>Bounty Pool:</b> ${bountyPool.toLocaleString()} ‡∏ö‡∏≤‡∏ó`
        : ''
      }
    </div>
  `;
  document.getElementById('tourStateBox').innerHTML = html;
}
    // Popup KO - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ALIVE ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
window.openKOPopup = function(sourceIndex) {
  const data = getData();
  const source = data.players[sourceIndex];
  const targets = data.players
    .map((p, i) => ({ ...p, i }))
    .filter(p => p.status === 'Alive' && p.i !== sourceIndex);

  if (targets.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ALIVE ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ KO');
    return;
  }

  let html = `<h3 style="color:#00bfff;margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ K.O.</h3>`;
  html += targets.map(t =>
    `<button class="modal-btn" onclick="confirmKOTarget(${sourceIndex},${t.i})">${t.name}</button>`
  ).join('');
  html += `<button class="btn" style="margin-top:10px;" onclick="closeKOPopup()">Cancel</button>`;

  let modal = document.createElement('div');
  modal.id = "koModal";
  modal.className = "modal-bg";
  modal.innerHTML = `<div class="modal-content">${html}</div>`;
  document.body.appendChild(modal);
  document.body.style.overflow = "hidden";
};

window.closeKOPopup = function() {
  const modal = document.getElementById('koModal');
  if (modal) modal.remove();
  document.body.style.overflow = "";
};

// ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ KO ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
window.confirmKOTarget = function(sourceIndex, targetIndex) {
  const data = getData();
  const source = data.players[sourceIndex];
  const target = data.players[targetIndex];
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ "${source.name}" KO "${target.name}" ?`)) return;
  handleKO(sourceIndex, targetIndex);
}

// KO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
window.handleKO = function(sourceIndex, targetIndex) {
  let data = getData();
  let log = JSON.parse(localStorage.getItem('koLog') || '[]');
  const source = data.players[sourceIndex];
  const target = data.players[targetIndex];
  if (sourceIndex === targetIndex) return;

  if (target.status === 'Alive' && target.bounty > 0) {
    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° KO ‡πÉ‡∏´‡πâ source
    source.ko = (source.ko || 0) + 1;
    // 2. ‡πÄ‡∏Å‡πá‡∏ö bounty ‡∏Ç‡∏≠‡∏á target ‡∏Å‡πà‡∏≠‡∏ô
    const bountyAmount = target.bounty;
    // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° bounty/earning
    source.bounty = (source.bounty || 0) + (bountyAmount / 2);
    source.earning = (source.earning || 0) + bountyAmount;
    // 4. bounty ‡∏Ç‡∏≠‡∏á target ‡πÄ‡∏õ‡πá‡∏ô 0
    target.bounty = 0;
    // 5. status ‡∏Ç‡∏≠‡∏á target ‡πÄ‡∏õ‡πá‡∏ô Dead
    target.status = 'Dead';
    // 6. log
    log.push({
      time: new Date().toISOString(),
      action: `${source.name} K.O ${target.name} Get ${bountyAmount} Bounties`
    });
    localStorage.setItem('koLog', JSON.stringify(log));
    saveData(data);
    renderEntries();
    renderTourStateBox();
    closeKOPopup();
  }
};
document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closeKOPopup();
});

function openDisplay() {
  const tourKey = localStorage.getItem('currentTourKey');
  if (!tourKey) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô (currentTourKey)');
    return;
  }
  window.open('display.html?tourKey=' + encodeURIComponent(tourKey), '_blank');
}




</script>
</body>
</html>

