<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Luxu Tournament Index</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <style>
#status-popup button {
  margin: 5px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
}

#data-container table {
  border-collapse: collapse;
  width: 100%;
  background-color: #fff;
  font-size: 14px;
  margin-top: 10px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}

#data-container th, #data-container td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}

#data-container th {
  background-color: #f0f0f0;
  color: #333;
  font-weight: bold;
}

#data-container td button {
  padding: 4px 8px;
  font-size: 12px;
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
}

#data-container td button:hover {
  background-color: #e0e0e0;
}

#data-container img {
  vertical-align: middle;
  margin-left: 5px;
  cursor: pointer;
}

.layout {
  display: flex;
  flex-wrap: wrap;        /* ‚úÖ ‡πÉ‡∏´‡πâ wrap ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Ñ‡∏ö */
  align-items: flex-start;
  gap: 20px;
  margin-top: 20px;
}

.left-panel {
  flex: 0 0 35%;           /* ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
  max-width: 400px;
  background-color: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  box-sizing: border-box;
}

.right-panel {
  flex: 1;
  min-width: 300px;
  background-color: #fff;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

@media (max-width: 768px) {
  .layout {
    flex-direction: column;
  }
  .left-panel,
  .right-panel {
    width: 100%;
    flex: none;
  }
}

    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    .hidden { display: none; }
    #data-container div { margin: 5px 0; }
    button { padding: 6px 14px; margin: 5px; }
   
    .menu-buttons button {
      font-size: 14px;
      padding: 6px 10px;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
    }
    .form-group { margin-bottom: 12px; }
    label span.required { color: red; }
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .form-row input, .form-row select {
      flex: 1;
      padding: 8px;
    }
    .toolbar-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .toolbar-buttons button {
      padding: 6px 12px;
    }
   
  </style>
</head>
<body>
  <div class="titlepagr" style="text-align: center;">
<h1>üéØ Luxu Tournament Index</h1>
<p>üë§ <span id="user-email"></span> <button onclick="logout()">Logout</button></p>
</div>

<div class="layout">
  <div class="left-panel">
    <div class="menu-buttons">
      
      
      <div style="text-align:center; margin-bottom: 30px;">
  <div style="text-align: center; margin-bottom: 20px;">
  <button onclick="window.open('tour-history.html', '_blank')" style="
    background-color: #b58e00;
    color: white;
    padding: 10px 24px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  ">
    üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô
  </button>
</div>
<select id="tour-list">
      <option value="">-- Selecte tour --</option>
    </select>
<button onclick="showCreateForm()">‚ûï Create Tour</button>
<button onclick="finishTournament()">üèÅ Finish</button>
 <button onclick="confirmLoadTour()">üìÇ Load Tour</button>
      <button onclick="deleteTour()">üóëÔ∏è Delete Tour</button>
</div>

    
    </div>
    
    <div id="create-form">
  <div class="form-group">
    <label>Tournament Name <span class="required">*</span></label>
    <input type="text" style="height: 30px;" id="tournamentName" required>
  </div>
  <div class="form-row">
    <div>
      <label>Start Date <span class="required">*</span></label>
      <input type="date" id="startDate" required>
    </div>
    <div>
      <label>Start Time <span class="required">*</span></label>
      <input type="time" id="startTime" required>
    </div>
  </div>
  <div class="form-row">
    <div>
      <label>Game Type <span class="required">*</span></label>
      <select id="gameType" required>
        <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>
        <option value="Tour">Tour</option>
        <option value="Bounty">Bounty</option>
      </select>
    </div>
    <div>
      <label>Guarantee</label>
      <input type="number" id="guarantee">
    </div>
  </div>
  <div class="form-row">
    <div>
      <label>Buy-in <span class="required">*</span></label>
      <input type="number" id="buyIn" required>
    </div>
    <div>
      <label>Re-buy <span class="required">*</span></label>
      <input type="number" id="reBuy" required>
    </div>
  </div>
  <div class="form-row">
    <div>
      <label>Allow Add-on <span class="required">*</span></label>
      <select id="allowAddon" onchange="handleAddonChange()">
        <option value="Y">Y</option>
        <option value="N" selected>N</option>
      </select>
    </div>
    <div>
      <label>Add-on Cost <span class="required" id="addonCostRequired" style="display:none">*</span></label>
      <input type="number" id="addonCost" disabled>
    </div>
  </div>
  <div class="form-row">
    <div>
      <label>Starting Stack <span class="required">*</span></label>
      <input type="number" id="startingStack" oninput="autoFillAddonStack()" required>
    </div>
    <div>
      <label>Add-on Stack</label>
      <input type="number" id="addonStack" disabled>
    </div>
  </div>
  <div class="toolbar-buttons">
    <button onclick="showPlayerPanel()">+Player</button>
    <button onclick="window.open('structure.html?tour=' + currentTourName, '_blank')">Structure</button>
    <button onclick="openPrizepool()">Prizepool</button>
    <button onclick="enableEditMode()">Edit</button>
    <button onclick="window.open('display.html?tour=' + currentTourName, '_blank')">Display</button>
    <button onclick="saveTournament()">Save</button>
  </div>
</div>
  </div>
  <div class="right-panel">
    <div id="data-container"></div>
  </div>
</div>
<!-- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á popup modal -->
<div id="koModal" style="display:none; position:fixed; top:30%; left:50%; transform:translateX(-50%); background:white; padding:20px; border:1px solid gray; z-index:1000;">
  <h3>üî´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ KO</h3>
  <select id="koTargetSelect" style="margin-bottom:10px;"></select><br>
  <button onclick="confirmKO()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô KO</button>
  <button onclick="closeKoModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>


<script>
let latestTourData = {};
let currentTourName = null;
let isEditMode = false;

  function logout() {
    firebase.auth().signOut();
  }

  function showCreateForm() {
  resetCreateForm();        // üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  lockFormFields(false);    // ‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ü‡∏¥‡∏•‡∏î‡πå
  document.getElementById("create-form").classList.remove("hidden");
  handleAddonChange();      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á add-on
}


  function handleAddonChange() {
    const allow = document.getElementById("allowAddon").value;
    const costLabel = document.getElementById("addonCostRequired");
    const costInput = document.getElementById("addonCost");
    const addonStack = document.getElementById("addonStack");
    if (allow === "Y") {
      costLabel.style.display = 'inline';
      costInput.required = true;
      costInput.disabled = false;
      addonStack.disabled = false;
      autoFillAddonStack();
    } else {
      costLabel.style.display = 'none';
      costInput.required = false;
      costInput.disabled = true;
      costInput.value = '';
      addonStack.value = '';
      addonStack.disabled = true;
    }
  }

  function autoFillAddonStack() {
    const allow = document.getElementById("allowAddon").value;
    const base = parseFloat(document.getElementById("startingStack").value);
    const addonStack = document.getElementById("addonStack");
    if (allow === "Y" && base) {
      addonStack.value = Math.round(base * 1.5);
    }
  }

  function saveTournament() {
    const name = document.getElementById("tournamentName").value.trim();
    const startDate = document.getElementById("startDate").value;
    const startTime = document.getElementById("startTime").value;
    const gameType = document.getElementById("gameType").value;
    const guarantee = document.getElementById("guarantee").value;
    const buyIn = document.getElementById("buyIn").value;
    const reBuy = document.getElementById("reBuy").value;
    const allowAddon = document.getElementById("allowAddon").value;
    const addonCost = document.getElementById("addonCost").value;
    const startingStack = document.getElementById("startingStack").value;
    const addonStack = document.getElementById("addonStack").value;

    if (!name || !startDate || !startTime || !gameType || !buyIn || !reBuy || !startingStack || (allowAddon === 'Y' && !addonCost)) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      return;
    }

    const tourData = {
      name,
      startDate,
      startTime,
      gameType,
      guarantee: guarantee || null,
      buyIn: parseFloat(buyIn),
      reBuy: parseFloat(reBuy),
      allowAddon,
      addonCost: allowAddon === 'Y' ? parseFloat(addonCost) : null,
      startingStack: parseFloat(startingStack),
      addonStack: allowAddon === 'Y' ? parseFloat(addonStack) : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const lastName = localStorage.getItem("lastLoadedTour");

if (name === lastName) {
  const confirmOverwrite = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (!confirmOverwrite) {
    const newName = prompt("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:");
    if (!newName) {
      alert("‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà");
      return;
    }
    tourData.name = newName;
    db.collection("tournaments").doc(newName).set(tourData)
      .then(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        lockFormFields(true); // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        localStorage.setItem("lastLoadedTour", newName);
        currentTourName = newName;
        isEditMode = false;
        loadTourList();
      })
      .catch(err => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message));
  } else {
    db.collection("tournaments").doc(name).set(tourData)
      .then(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        lockFormFields(true); // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        localStorage.setItem("lastLoadedTour", name);
        currentTourName = name;
        isEditMode = false;
        loadTourList();
      })
      .catch(err => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message));
  }
} else {
  db.collection("tournaments").doc(name).set(tourData)
    .then(() => {
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      lockFormFields(true); // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      localStorage.setItem("lastLoadedTour", name);
      currentTourName = name;
      isEditMode = false;
      showPlayerPanel();
      loadTourList();
    })
    .catch(err => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message));
    
}

  }

  function confirmLoadTour() {
  const tourName = document.getElementById("tour-list").value;
  if (!tourName) {
    alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î");
    return;
  }
  const confirmLoad = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠: " + tourName + " ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (confirmLoad) loadTour(tourName);
  
}

function loadTour(tourName) {
  db.collection("tournaments").doc(tourName).get().then(doc => {
    if (!doc.exists) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠: " + tourName);
      return;
    }
    const data = doc.data();

    localStorage.setItem("lastLoadedTour", tourName);
    document.getElementById("tournamentName").value = data.name || "";
    document.getElementById("startDate").value = data.startDate || "";
    document.getElementById("startTime").value = data.startTime || "";
    document.getElementById("gameType").value = data.gameType || "";
    document.getElementById("guarantee").value = data.guarantee || "";
    document.getElementById("buyIn").value = data.buyIn || "";
    document.getElementById("reBuy").value = data.reBuy || "";
    document.getElementById("allowAddon").value = data.allowAddon || "N";
    document.getElementById("addonCost").value = data.addonCost || "";
    document.getElementById("startingStack").value = data.startingStack || "";
    document.getElementById("addonStack").value = data.addonStack || "";
    handleAddonChange();

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    currentTourName = tourName;
    isEditMode = false;
    lockFormFields(true);
    if (localStorage.getItem("showRightPanel") === "true") {
  showPlayerPanel();
}    alert("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
  }).catch(err => {
    console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", err);
    alert("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
  });
}

function loadTourList() {
  const select = document.getElementById("tour-list");

  db.collection("tournaments").orderBy("createdAt", "desc").onSnapshot(snapshot => {
    select.innerHTML = '<option value="">-- Selecte tour --</option>';
    snapshot.forEach(doc => {
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = doc.id;
      select.appendChild(option);
    });
  }, err => {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå:", err);
  });
}

function loadLastTourIfExists() {
  const last = localStorage.getItem("lastLoadedTour");
  if (last) loadTour(last);
}
window.onload = function () {
  initFirebaseAuth();
  loadTourList();

  const last = localStorage.getItem("lastLoadedTour");
  if (last) {
    loadTour(last);
  } else {
    showCreateForm(); // üëâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ tour ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÇ‡∏´‡∏•‡∏î
  }
};
function deleteTour() {
  const tourName = document.getElementById("tour-list").value;
  if (!tourName) {
    alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö");
    return;
  }

  const confirmDelete = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå: " + tourName + " ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?");
  if (!confirmDelete) return;

  db.collection("tournaments").doc(tourName).delete()
    .then(() => {
      alert("üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏à‡∏≤‡∏Å localStorage
      if (localStorage.getItem("lastLoadedTour") === tourName) {
        localStorage.removeItem("lastLoadedTour");
        localStorage.removeItem("showRightPanel");
        localStorage.removeItem("showRightPanel");
      }

      // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
      loadTourList();

      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á
      const fields = [
        "tournamentName", "startDate", "startTime", "gameType",
        "guarantee", "buyIn", "reBuy", "allowAddon",
        "addonCost", "startingStack", "addonStack"
      ];
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ dependent ‡πÄ‡∏ä‡πà‡∏ô disable ‡∏ä‡πà‡∏≠‡∏á addon
      handleAddonChange();
    })
    .catch(err => {
      console.error("‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÑ‡∏î‡πâ: " + err.message);
    });
}
function resetCreateForm() {
  const ids = [
    "tournamentName", "startDate", "startTime", "gameType",
    "guarantee", "buyIn", "reBuy", "allowAddon",
    "addonCost", "startingStack", "addonStack"
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === 'SELECT') {
        el.selectedIndex = id === 'allowAddon' ? 1 : 0; // N ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ default
      } else {
        el.value = "";
      }
    }
  });
  localStorage.removeItem("lastLoadedTour");
  handleAddonChange();
}
function lockFormFields(lock) {
  const ids = [
    "tournamentName", "startDate", "startTime", "gameType",
    "guarantee", "buyIn", "reBuy", "allowAddon",
    "addonCost", "startingStack", "addonStack"
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = lock;
  });
}
function enableEditMode() {
  if (!currentTourName) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
    return;
  }
  lockFormFields(false); // üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á input
  isEditMode = true;
  alert("üîì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏Å‡∏î Save ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà");
}

function showPlayerPanel() {
  localStorage.setItem("showRightPanel", "true");

  if (!currentTourName) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  db.collection("tournaments").doc(currentTourName).onSnapshot(doc => {
    const data = doc.data();
    const panel = document.getElementById("data-container");
    panel.innerHTML = "";

    // --- ‡∏Å‡∏•‡πà‡∏≠‡∏á TOUR INFO ---
    const orderedFields = [
      { key: 'tournamentName', label: 'TOURNAMENT ', value: currentTourName },
      { key: 'startDate', label: 'DATE ' },
      { key: 'startTime', label: 'TIME ' },
      { key: 'gameType', label: 'TYPE ' },
      { key: 'guarantee', label: 'GUARANTEE ' },
      { key: 'buyIn', label: 'BUY-IN ' },
      { key: 'addonCost', label: 'ADD-ON ' },
      { key: 'rebuyChips', label: 'RE-BUY CHIPS ' },
      { key: 'reBuy', label: 'RE-BUY ' },
      { key: 'startingStack', label: 'STARTING STACK ' },
      { key: 'addonStack', label: 'ADD-ON STACK ' }
    ];

    let infoHTML = `<div style="border-bottom:1px solid #ccc; margin-bottom:10px;">
      <h3>üìã TOUR INFO</h3>
      <div style="display:flex; flex-wrap:wrap; gap:10px;">`;

    orderedFields.forEach(({ key, label, value }) => {
      const showValue = value !== undefined ? value : data[key];
      if (showValue !== undefined && showValue !== "") {
        infoHTML += `<div style="min-width:200px;"><strong>${label}:</strong> ${showValue}</div>`;
      }
    });

    infoHTML += `</div></div>`;
    panel.innerHTML += infoHTML;

    // --- ‡∏Å‡∏•‡πà‡∏≠‡∏á TOUR STATE ---
  const stateTitle = data.gameType === "Bounty" ? "üìä BOUNTY STATE" : "üìä TOURNAMENT STATE";
panel.innerHTML += `
  <div id="bounty-state-box" style="...">
    <h3>${stateTitle}</h3>
    <p id="entry-summary">Entry: 0, Re-entry: 0, Add-on: 0, Remaining: 0</p>
    <p id="stack-summary">Total Stack: 0, Average Stack: 0</p>  
  </div>
`;


    // --- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡∏ß‡∏£‡πå ---
    if (data.gameType === "Tour") {
      renderTourTable(data);
    } else if (data.gameType === "Bounty") {
      renderBountyTable(data);
    }
  });
}

function renderTourTable(data) {
  const panel = document.getElementById("data-container");
  panel.innerHTML += `
    <h3>üßç‚Äç‚ôÇÔ∏è Add Player</h3>
    <input type="text" id="newPlayerName" placeholder="Player name">
    <button onclick="addPlayer()">‚ûï Entry</button>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Player Name</th><th>Status</th>
          <th>Re-buy</th><th>Add-on</th><th>Delete</th>
        </tr>
      </thead>
      <tbody id="tour-player-table-body"></tbody>
    </table>
  `;

  const tbody = document.getElementById("tour-player-table-body");
  const tourRef = db.collection("tournaments").doc(currentTourName).collection("players");
  const startingStack = Number(data.startingStack || 0);
  const addonStack = Number(data.addonStack || 0);

  tourRef.orderBy("createdAt").onSnapshot(snapshot => {
    if (!tbody) return;
    tbody.innerHTML = "";

    let index = 1, entry = 0, rebuy = 0, addon = 0, remaining = 0;

    snapshot.forEach(doc => {
      const p = doc.data();
      entry++;
      if (p.status === "Active") remaining++;
      if (p.reBuyCount) rebuy += p.reBuyCount;
      if (p.addonUsed) addon++;

      const rebuyBtn = p.status === "BUST"
        ? `<button onclick="handleRebuy('${doc.id}')">Re-buy (${p.reBuyCount || 0})</button>`
        : `<button disabled style="opacity:0.4">Re-buy (${p.reBuyCount || 0})</button>`;

      const addonBtn = p.status === "Active"
        ? (p.addonUsed ? '‚úÖ' : `<button onclick="handleAddon('${doc.id}')">Add-on</button>`)
        : "‚ùå";

      const statusBtn = p.status === "Active"
        ? `<img src="gear.png" style="width:16px" onclick="setStatus('${doc.id}')">`
        : "‚ùå";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index++}</td>
        <td>${doc.id}</td>
        <td>${p.status} ${statusBtn}</td>
        <td>${rebuyBtn}</td>
        <td>${addonBtn}</td>
        <td><button onclick="removePlayer('${doc.id}')">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });

    const totalStack = (entry + rebuy) * startingStack + addon * addonStack;
    const avgStack = remaining > 0 ? Math.floor(totalStack / remaining) : 0;

    document.getElementById("entry-summary").innerText =
      `Entry: ${entry}, Re-entry: ${rebuy}, Add-on: ${addon}, Remaining: ${remaining}`;
    document.getElementById("stack-summary").innerText =
      `Total Stack: ${totalStack}, Average Stack: ${avgStack}`;
      updateTournamentState({
      entry,
      rebuy,
      addon,
      remaining,
      totalStack,
      avgStack
    });
  });
};


function renderBountyTable(data) {
  const panel = document.getElementById("data-container");
  panel.innerHTML += `
    <h3>üßç‚Äç‚ôÇÔ∏è Add Player</h3>
    <input type="text" id="newPlayerName" placeholder="Player name">
    <button onclick="addPlayerBounty()">‚ûï Entry</button>
    <table border="1" style="margin-top:10px; width:100%; text-align:left;">
      <thead>
        <tr>
          <th>#</th><th>Player Name</th><th>Status</th><th>Bounty</th>
          <th>KO</th><th>Earning</th><th>Re-buy</th><th>Add-on</th><th>Delete</th>
        </tr>
      </thead>
      <tbody id="bounty-player-table-body"></tbody>
    </table>
  `;

  const tbody = document.getElementById("bounty-player-table-body");
  const playerRef = db.collection("tournaments").doc(currentTourName).collection("players");
  const bountyBase = Math.floor(Number(data.buyIn || 0) / 4);
  const startingStack = Number(data.startingStack || 0);
  const addonStack = Number(data.addonStack || 0);

  playerRef.orderBy("createdAt").onSnapshot(snapshot => {
    if (!tbody) return;
    tbody.innerHTML = "";

    let index = 1;
    let entryCount = 0, rebuyCount = 0, addonCount = 0, aliveCount = 0;

    snapshot.forEach(doc => {
      const p = doc.data();
      const isAlive = p.status === "ALIVE";

      entryCount++;
      rebuyCount += p.rebuyUsed || 0;
      if (p.addonUsed) addonCount++;
      if (isAlive) aliveCount++;

      const koCount = p.koCount || 0;
      const rebuyUsed = p.rebuyUsed || 0;

      const rebuyBtn = !isAlive
        ? `<button onclick="handleRebuy('${doc.id}')">Re-buy (${rebuyUsed})</button>`
        : `<button disabled style="opacity:0.4">Re-buy (${rebuyUsed})</button>`;

      const addonBtn = isAlive && !p.addonUsed
        ? `<button onclick="handleAddon('${doc.id}')">Add-on</button>`
        : p.addonUsed ? '‚úîÔ∏è' : "‚ùå";

      const koBtn = isAlive
        ? `<button onclick="handleKO('${doc.id}')">KO (${koCount})</button>`
        : `<button disabled style="opacity:0.4">KO (${koCount})</button>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index++}</td>
        <td>${doc.id}</td>
        <td>${p.status}</td>
        <td>${p.bounty || 0}</td>
        <td>${koBtn}</td>
        <td>${p.earning || 0}</td>
        <td>${rebuyBtn}</td>
        <td>${addonBtn}</td>
        <td><button onclick="removePlayer('${doc.id}')">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });

    const totalStack = (entryCount + rebuyCount) * startingStack + addonCount * addonStack;
    const avgStack = aliveCount > 0 ? Math.floor(totalStack / aliveCount) : 0;

    document.getElementById("entry-summary").innerText =
      `Entry: ${entryCount}, Re-entry: ${rebuyCount}, Add-on: ${addonCount}, Remaining: ${aliveCount}`;
    document.getElementById("stack-summary").innerText =
      `Total Stack: ${totalStack}, Average Stack: ${avgStack}`;
      updateTournamentState({
  entry: entryCount,
  rebuy: rebuyCount,
  addon: addonCount,
  remaining: aliveCount,
  totalStack,
  avgStack
    });
  });
};



function addPlayer() {
  const name = document.getElementById("newPlayerName").value.trim();
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");

  db.collection("tournaments").doc(currentTourName).get().then(doc => {
    const data = doc.data();
    const gameType = data.gameType;

    const newData = {
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (gameType === "Tour") {
      newData.status = "Active";
      newData.reBuyCount = 0;
      newData.addonUsed = false;
    } else {
      newData.status = "ALIVE";
      newData.bounty = Math.floor(Number(data.buyIn || 0) / 4);
      newData.koCount = 0;
      newData.earning = 0;
      newData.rebuyUsed = 0;
      newData.addonUsed = false;
    }

    db.collection("tournaments").doc(currentTourName).collection("players")
      .doc(name).set(newData)
      .then(() => {
        alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        document.getElementById("newPlayerName").value = "";
      });
  });
}

function removePlayer(name) {
  const confirmDel = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: " + name + "?");
  if (!confirmDel) return;
  db.collection("tournaments").doc(currentTourName).collection("players").doc(name).delete();
}
function removePlayer(playerName) {
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  const playerRef = db.collection("tournaments").doc(currentTourName).collection("players").doc(playerName);

  playerRef.get().then(doc => {
    if (!doc.exists) return;

    const data = doc.data();
    const entryDelta = 1;
    const rebuyDelta = data.reBuyCount || 0;
    const addonDelta = data.addonUsed ? 1 : 0;
    const remainingDelta = data.status === "ALIVE" ? 1 : 0;

    // ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏Å
    playerRef.delete().then(() => {
      console.log(`‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerName} ‡πÅ‡∏•‡πâ‡∏ß`);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢ onSnapshot ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å snapshot ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ manually ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    });
  });
}
function setStatus(playerName) {
  // ‡∏•‡∏ö popup ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
  const old = document.getElementById("status-popup");
  if (old) old.remove();

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup
  const popup = document.createElement("div");
  popup.id = "status-popup";
  popup.style.position = "fixed";
  popup.style.top = "30%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "#fff";
  popup.style.border = "1px solid #ccc";
  popup.style.padding = "20px";
  popup.style.zIndex = "9999";
  popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
  popup.innerHTML = `
    <h3>‚öôÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á ${playerName}</h3>
    <button onclick="confirmStatus('${playerName}', 'BUST')">üí• BUST</button>
    <button onclick="confirmStatus('${playerName}', 'OUT')">üö™ OUT</button>
    <button onclick="document.getElementById('status-popup').remove()">‚ùå Cancel</button>
  `;
  document.body.appendChild(popup);
}

function confirmStatus(playerName, status) {
  const updateData = { status: status };

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° koTime ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô BUST ‡∏´‡∏£‡∏∑‡∏≠ OUT
  if (status === "BUST" || status === "OUT") {
    updateData.koTime = firebase.firestore.FieldValue.serverTimestamp();
  }

  db.collection("tournaments")
    .doc(currentTourName)
    .collection("players")
    .doc(playerName)
    .update(updateData)
    .then(() => {
      console.log(`‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${playerName} ‡πÄ‡∏õ‡πá‡∏ô ${status}`);
      document.getElementById('status-popup').remove();
    });
}


function handleRebuy(playerId) {
  if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Re-buy ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  db.collection("tournaments").doc(currentTourName).get().then(doc => {
    const data = doc.data();
    const gameType = data.gameType;

    if (gameType === "Tour") {
      db.collection("tournaments").doc(currentTourName).collection("players").doc(playerId).get()
        .then(playerDoc => {
          const pdata = playerDoc.data();
          const currentCount = pdata.reBuyCount || 0;

          db.collection("tournaments").doc(currentTourName).collection("players").doc(playerId).update({
            status: "Active",
            reBuyCount: currentCount + 1
          }).then(() => {
            alert(`‚úÖ Re-buy ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${currentCount + 1})`);
          });
        });

    } else if (gameType === "Bounty") {
      const bounty = Math.floor(Number(data.buyIn || 0) / 4);

      db.collection("tournaments").doc(currentTourName).collection("players").doc(playerId).get()
        .then(playerDoc => {
          const pdata = playerDoc.data();
          const rebuyUsed = pdata.rebuyUsed || 0;

          db.collection("tournaments").doc(currentTourName).collection("players").doc(playerId).update({
            status: "ALIVE",
            bounty: bounty,
            rebuyUsed: rebuyUsed + 1
          }).then(() => {
            alert(`‚úÖ Re-buy ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${rebuyUsed + 1})`);
          });
        });
    }
  });
}

function handleAddon(playerId) {
  if (!currentTourName) return;
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Add-on ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playerId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  const playerRef = db.collection("tournaments").doc(currentTourName).collection("players").doc(playerId);
  db.runTransaction(async (tx) => {
    const doc = await tx.get(playerRef);
    if (!doc.exists) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");

    const data = doc.data();
    if (data.addonUsed) throw new Error("‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Add-on ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");

    tx.update(playerRef, {
      addonUsed: true,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }).then(() => {
    alert(`‚úÖ Add-on ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${playerId}`);
  }).catch(err => {
    console.error("‚ùå Add-on error:", err);
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥ Add-on ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
  });
}
function addPlayerBounty() {
  const input = document.getElementById("newPlayerName");
  const name = input.value.trim();
  if (!name) {
    alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
    return;
  }

  const tourRef = db.collection("tournaments").doc(currentTourName);
  const playerRef = tourRef.collection("players").doc(name);

  playerRef.get().then(doc => {
    if (doc.exists) {
      alert("‚ö†Ô∏è ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
      return;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ buy-in ‡∏à‡∏≤‡∏Å tournament document
    tourRef.get().then(tourDoc => {
      if (!tourDoc.exists) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå");
        return;
      }

      const buyIn = Number(tourDoc.data().buyIn || 0);
      const bountyValue = Math.floor(buyIn / 4);

      const playerData = {
        status: "ALIVE",
        rebuyUsed: 0,
        addonUsed: false,
        bounty: bountyValue,
        earning: 0,
        koCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      playerRef.set(playerData).then(() => {
        alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
        input.value = "";
      }).catch(err => {
        console.error("‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
      });
    });
  }).catch(err => {
    console.error("‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ");
  });
}



function openKOPopup(koById) {
  const popup = document.createElement("div");
  popup.id = "ko-popup";
  popup.style = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border:1px solid black;z-index:1000";

  popup.innerHTML = `<h3>üî´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ KO</h3><div id="ko-targets"></div><br><button onclick="document.body.removeChild(document.getElementById('ko-popup'))">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;

  document.body.appendChild(popup);

  // ‡∏î‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á ALIVE ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
  db.collection("tournaments").doc(currentTourName).collection("players")
    .where("status", "==", "ALIVE")
    .get().then(snapshot => {
      const container = document.getElementById("ko-targets");
      snapshot.forEach(doc => {
        if (doc.id !== koById) {
          const btn = document.createElement("button");
          btn.innerText = doc.id;
          btn.onclick = () => confirmKO(koById, doc.id);
          container.appendChild(btn);
        }
      });
    });
}



function closeKOPopup() {
  const popup = document.getElementById("ko-popup");
  if (popup) popup.remove();
}
let currentKOInitiator = null;

function handleKO(playerId) {
  currentKOInitiator = playerId;

  const modal = document.getElementById("koModal");
  const select = document.getElementById("koTargetSelect");

  if (!modal || !select) {
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö popup KO ‡∏´‡∏£‡∏∑‡∏≠ select");
    return;
  }

  // ‡∏•‡πâ‡∏≤‡∏á options ‡πÄ‡∏Å‡πà‡∏≤
  select.innerHTML = "";

  // ‡∏î‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ALIVE ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà KO
  db.collection("tournaments").doc(currentTourName).collection("players")
    .where("status", "==", "ALIVE")
    .get()
    .then(snapshot => {
      let hasOtherPlayers = false;
      snapshot.forEach(doc => {
        if (doc.id !== playerId) {
          hasOtherPlayers = true;
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = doc.id;
          select.appendChild(option);
        }
      });

      if (!hasOtherPlayers) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ALIVE ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
      }

      modal.style.display = "block";
    })
    .catch(err => {
      console.error("‚ùå ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    });
}

function confirmKO() {
  const select = document.getElementById("koTargetSelect");
  if (!select || !currentKOInitiator) return;

  const targetId = select.value;
  if (!targetId) {
    alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ KO");
    return;
  }

  const tourRef = db.collection("tournaments").doc(currentTourName);
  const playersRef = tourRef.collection("players");
  const logRef = tourRef.collection("logs");

  Promise.all([
    playersRef.doc(currentKOInitiator).get(),
    playersRef.doc(targetId).get()
  ])
  .then(([initiatorSnap, targetSnap]) => {
    const initiator = initiatorSnap.data();
    const target = targetSnap.data();

    const bountyEarned = target.bounty || 0;
    const newBounty = (initiator.bounty || 0) + Math.floor(bountyEarned / 2);
    const newEarning = (initiator.earning || 0) + bountyEarned;
    const newKOCount = (initiator.koCount || 0) + 1;

    const batch = db.batch();

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ KO
    batch.update(playersRef.doc(currentKOInitiator), {
      bounty: newBounty,
      earning: newEarning,
      koCount: newKOCount
    });

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å KO
    batch.update(playersRef.doc(targetId), {
      status: "DEAD",
      bounty: 0,
      koTime: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° log
    batch.set(logRef.doc(Date.now().toString()), {
      type: "KO",
      playerA: currentKOInitiator,
      playerB: targetId,
      bounty: bountyEarned,
      time: new Date()
    });

    return batch.commit();
  })
  .then(() => {
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£ KO ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    document.getElementById("koModal").style.display = "none";
    currentKOInitiator = null;
  })
  .catch(err => {
    console.error("‚ùå KO ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å KO");
  });
}

function closeKoModal() {
  document.getElementById("koModal").style.display = "none";
  currentKOInitiator = null;
}


function goToStructure() {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á");
    return;
  }
  if (!currentTourName) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á");
    return;
  }

  const tourName = encodeURIComponent(currentTourName);
  window.location.href = `structure.html?tour=${tourName}`;
}
function openPrizepool() {
  if (!currentTourName) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  const uid = user.uid;
  window.open(`prizepool.html?tour=${encodeURIComponent(currentTourName)}&uid=${uid}`, '_blank');
}

window.open(`display.html?tour=${encodeURIComponent(currentTourName)}`, '_blank');

function updateTournamentState(state) {
  if (!currentTourName) return;

  db.collection("tournaments")
    .doc(currentTourName)
    .collection("state")
    .doc("summary")
    .set({
      entry: state.entry,
      rebuy: state.rebuy,
      addon: state.addon,
      remaining: state.remaining,
      totalStack: state.totalStack,
      avgStack: state.avgStack,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      console.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å state ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", state);
    }).catch(err => {
      console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å state ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
    });
}

async function finishTournament() {
  if (!currentTourName) {
    alert("‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const tourRef = db.collection("tournaments").doc(currentTourName);
  const stateRef = tourRef.collection("state").doc("summary");
  const playersRef = tourRef.collection("players");
  const prizeRef = tourRef.collection("prizepool");

  try {
    const [tourDoc, stateDoc, playersSnap, prizeSnap] = await Promise.all([
      tourRef.get(),
      stateRef.get(),
      playersRef.get(),
      prizeRef.orderBy("rank").get()
    ]);

    if (!tourDoc.exists || !stateDoc.exists) {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠ state");
      return;
    }

    const tourData = tourDoc.data();
    const stateData = stateDoc.data();
    const gameType = (tourData.gameType || "TOUR").toUpperCase();

    const players = [];
    playersSnap.forEach(doc => {
      const p = doc.data();
      players.push({
        name: doc.id,
        stack: p.stack || 0,
        status: (p.status || "").toUpperCase(),
        koTime: p.koTime || null
      });
    });

    let rankedPlayers = [];

    if (gameType === "TOUR") {
      const alive = players.filter(p => ["ALIVE", "ACTIVE"].includes(p.status));
      const busted = players
        .filter(p => ["BUST", "OUT"].includes(p.status) && p.koTime)
        .sort((a, b) => b.koTime.toDate() - a.koTime.toDate());
      rankedPlayers = [...alive, ...busted];
    } else {
      const alive = players.filter(p => p.status === "ALIVE");
      const dead = players
        .filter(p => p.status === "DEAD" && p.koTime)
        .sort((a, b) => b.koTime.toDate() - a.koTime.toDate());
      rankedPlayers = [...alive, ...dead];
    }

    const prizepool = [];
    prizeSnap.forEach(doc => {
      const d = doc.data();
      prizepool.push({ rank: d.rank, amount: d.amount });
    });

    const winners = [];
    prizepool.forEach((prize, index) => {
      const player = rankedPlayers[index];
      if (player) {
        winners.push({
          rank: prize.rank,
          name: player.name,
          stack: player.stack,
          status: player.status,
          koTime: player.koTime || null,
          prize: prize.amount
        });
        prize.winner = player.name;
      } else {
        prize.winner = null;
      }
    });

    // ‚¨áÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á tournamentHistory
    await db.collection("tournamentHistory").doc(currentTourName).set({
      info: tourData,
      finalState: stateData,
      winners,
      prizepool,
      finishedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // ‚¨áÔ∏è ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å subcollection
    const subcollectionsToDelete = ["players", "state", "prizepool", "logs", "structure"];
    for (const subCol of subcollectionsToDelete) {
      const snapshot = await tourRef.collection(subCol).get();
      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    }

    // ‚¨áÔ∏è ‡∏•‡∏ö document ‡∏´‡∏•‡∏±‡∏Å
    await tourRef.delete();

    // ‚¨áÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    alert("‚úÖ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    localStorage.removeItem("lastLoadedTour");
    loadTourList();

    const panel = document.getElementById("data-container");
    if (panel) panel.innerHTML = "";
    resetCreateForm();
    showCreateForm();

  } catch (err) {
    console.error("‚ùå finishTournament error:", err);
    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô");
  }
}

</script>

</body>
</html>
