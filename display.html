<!DOCTYPE html>
<html lang="th">
<head>
<!-- ✅ Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDqd20lb2fQSMjqsSmzUXXgQFhBNC8sB9g",
    authDomain: "luxutour-63450.firebaseapp.com",
    projectId: "luxutour-63450",
    storageBucket: "luxutour-63450.firebasestorage.app",
    messagingSenderId: "349190270077",
    appId: "1:349190270077:web:c52b936bdc2f06c7db1514",
    measurementId: "G-1F45DPS42M"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Display Tounament Info</title>
  <style>
 .info-box, .right-box, .center-box, .player-box, .player-table, .payout-table, .middle-half, .level-now, .level-elapsed, .timer {
  border: none !important;
  box-shadow: none !important;
  background: rgba(38,38,38,0.36) !important; /* พื้นโปร่งใสแบบเดิมได้ */
}
.payout-table th {
  background: rgba(19, 18, 18, 0.22) !important;
  color: #fff !important;
  font-weight: 700;
  letter-spacing: 0.5px;
  border: none !important;
  box-shadow: none !important;
  text-align: right;
}
.center, .left, .right {
  border: none !important;
  box-shadow: none !important;
}
.center, .left, .right {
  background: transparent !important;
  border: none !important;
}
.player-box-title, .tournament-name, .tournament-date, .player-table th, .player-table td {
  color: #f9fcff !important;
  text-shadow: 0 1px 4px #181c2077;
}

.right-sb, .right-bb, .right-ante, .right-nextlv {
  color: #f8df6b !important;
  text-shadow: 0 2px 7px #181c2039;
  background: transparent !important;
}

.middle-half, .late-reg, .level-now, .level-elapsed {
  background: rgba(60,60,80,0.32) !important;
  color: #fafbff !important;
}
.late-reg.open {
  background: rgba(45,180,90,0.88) !important;
  color: #fff !important;
}
.late-reg.closed {
  background: rgba(210,44,32,0.95) !important;
  color: #fff !important;
}

.info-box h2, .right-box h2 {
  color: #e0e6ff !important;
  text-shadow: 0 1px 3px #181c2060;
}

.player-table {
  background: rgba(24,28,36,0.66) !important;
}
.player-table th {
  background: rgba(36,54,76,0.33) !important;
  color: #ffea92 !important;
}
.player-table td {
  color: #fff !important;
}

.ko-toast {
  background: rgba(18,28,64,0.96) !important;
  color: #fff;
  text-shadow: 0 1px 7px #000c;
  border: 2.7px solid #ffe99399;
}

   html, body {
  height: 100%;
  width: 100%;
  margin: 0; padding: 0;
  overflow: hidden;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f4f6fc;
}
.info-box, .right-box, .center-box, .player-box, .player-table, .payout-table, .middle-half, .level-now, .level-elapsed, .timer {
  background: transparent !important;
  box-shadow: none !important;
  border-radius: 16px;
  border: 1.3px solid rgba(100,120,180,0.14);
}



.container {
  width: 100vw; height: 100vh;
  display: flex; flex-direction: row;
  overflow: hidden;
}

.col {
  min-height: 0; min-width: 0; box-sizing: border-box;
  display: flex; flex-direction: column; align-items: center;
  overflow: hidden;
}

.left, .right {
  width: 25vw;
  min-width: 200px;
  max-width: none;
  background: #f0f4ff;
  padding: 0;
  gap: 2px;
  align-items: stretch;
  justify-content: flex-start;
}
.left .info-box {
  font-size: 1.8em;
  color: rgb(255, 255, 255);
  text-align: center;
  margin-top: 5px;
}

.center {
  width: 50vw;
  min-width: 350px;
  max-width: none;
  background: #fff;
  gap: 10px; /* ลด gap ลง */
  align-items: center;
  justify-content: flex-start;
  border-left: 2px solid #dde4f7; 
  border-right: 2px solid #dde4f7;
  padding: 0;
  overflow: hidden;
}


.info-box, .right-box {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  background: #1b1a1a;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(80,100,180,0.10);
  padding: 22px 12px 18px 18px; /* ให้ padding ที่นี่แทน */
  min-height: 64px;
  margin-bottom: 0;
  font-size: 1.14rem;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-box h2, .right-box h2 {
  margin: 0 0 6px 0;
  font-size: 1.01em;
  color: #c5b30e;
  font-weight: 700;
  letter-spacing: 0.3px;
}

.center-box, .player-box {
  width: 98%;
  max-width: 900px;
  margin: 0 auto 8px auto;
  background: #f5f7fb;
  border-radius: 12px;
  box-shadow: 0 1px 8px rgba(90,110,200,0.09);
  padding: 16px 2vw 10px 2vw; /* ลด padding */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 12px; /* ลดช่องว่าง */
  margin-top: -30px;
}

.tournament-name {
  font-size: 2.8rem;
  font-weight: 800;
  color: #18305b;
  margin-top: 40px;
  text-align: center;
}

.tournament-date {
  font-size: 1.8rem;
  color: #444a5a;
  
  font-weight: 500;
  text-align: center;
  margin-top: -10px;
}

.level-row {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  gap: 20px; /* ลด gap */
  margin-bottom: 6px;
  margin-top: -20px;
}

.level-now, .level-elapsed {
  background: #f4f8fd;
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 1.8em;
  font-weight: 700;
  color: #245;
  min-width: 80px;
  text-align: center;
}

.timer {
  font-size: 18rem;
  font-weight: bold;
  color: #fffdfd;
  letter-spacing: 2px;
  margin: 7px 0 2px 0;
  text-align: center;
  background:transparent;
  border-radius: 10px;
  padding: 10px 0 10px 0;
  box-shadow: 0 0 5px 0 #fee6e3;
  margin-top: -40px;
}

.middle-row {
  display: flex;
  gap: 10px;
  align-items: stretch;
  width: 100%;
  margin: 8px 0 2px 0;
}

.middle-half {
  flex: 1;
  min-height: 56px;
  font-size: 2.15rem;     /* <<< ขยายขนาดใหญ่ขึ้น (เดิม 1.17rem) */
  font-weight: 700;
  background: #fff;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 4px rgba(90,120,180,0.06);
  color: #246;
  box-sizing: border-box;
  padding: 0 18px;        /* <<< เพิ่ม padding ให้ใหญ่ขึ้น */
  overflow-wrap: break-word; word-break: break-word;
  height: auto;
  letter-spacing: 1px;
}

/* ขยาย late-reg ขณะ "open" (ใช้ font-size เดียวกับ middle-half ก็ได้) */
.late-reg.open,
.late-reg.closed {
  font-size: 2.15rem !important;
  font-weight: 800 !important;
  padding-top: 5px;
  padding-bottom: 5px;
  border-radius: 12px;
}


.player-box-title {
  font-size: 2rem;
  font-weight: 800;
  color: #2951a3;
  margin-bottom: 7px;
  letter-spacing: 0.6px;
  text-align: center;
}

.player-list { font-size: 1rem; }
.player-list div { margin: 1px 0; }

.payout-table { width: 100%; font-size: 0.97em; margin-top: 2px; border-collapse: collapse; }
.payout-table th, .payout-table td { border-bottom: 1px solid #eef1fa; padding: 2px 4px 2px 0; text-align: left; }
.payout-table th { color: #3772c2; background: #f4f7fb; }

/* Responsive */
@media (max-width: 900px) {
  .container { flex-direction: column;}
  .left, .center, .right { width: 100vw; min-width: unset; border: none !important; padding: 5px 2px; }
  .center { border-top: 1.5px solid #dde4f7; border-bottom: 1.5px solid #dde4f7; gap: 7px; }
  .center-box, .player-box, .info-box, .right-box { padding: 8px 2vw 7px 2vw; }
  .timer { font-size: 1.2rem; }
  .tournament-name { font-size: 1rem; }
}

.late-reg {
  transition: background 0.3s, color 0.3s;
}

.late-reg.open {
  background: #36cc72 !important;
  color: #fff !important;
}

.late-reg.closed {
  background: #e54b3c !important;
  color: #fff !important;
  font-weight: bold;
  font-size: 1.4rem;
  letter-spacing: 1.2px;
  justify-content: center;
  align-items: center;
  display: flex;
}
.player-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1.8em;
  margin-top: 8px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 5px rgba(90,110,200,0.07);
}
.player-table th, .player-table td {
  padding: 8px 6px;
  border-bottom: 1px solid #eef1fa;
  text-align: center;
}
.player-table th {
  background: #f0f7fd;
  color: #2951a3;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.player-table tr:last-child td { border-bottom: none; }
.player-table td { font-weight: 500; color: #263246;}

.timer-controls {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 8px;
}
.timer-controls button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
}
.timer-controls img {
  width: 20px; height: 20px;
  vertical-align: middle;
  filter: drop-shadow(0 1px 3px #ddd);
  transition: filter 0.1s;
}
.timer-controls button:active img {
  filter: brightness(0.8);
}
.right-box {
  
  padding: 10px 16px 10px 16px;
  background: #fafdff;
  border-radius: 14px;
  box-shadow: 0 2px 9px rgba(40,80,180,0.07);
  position: relative;
  min-width: 110px;
  min-height: 60px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  text-align: center;
}

.right-box h2 {
  position: absolute;
  top: 10px;
  left: 18px;
  margin: 0;
  font-size: 0.98em;    /* ตัวเล็กลง */
  color: #2a7bd6;
  font-weight: 700;
  opacity: 0.85;
  letter-spacing: 0.5px;
  pointer-events: none;
  user-select: none;
}

.right-sb,
.right-bb,
.right-ante{
  font-size: 8em;    /* ตัวเลขใหญ่ */
  color: #17366a;
  font-weight: 400;
  margin-top: -10px;     /* เผื่อระยะ label ด้านบน */
  margin-bottom: 2px;
  width: 100%;
  text-align: left;
  letter-spacing: 1.2px;
  line-height: 1.4em;
  word-break: break-all;
  text-align: center;
  height: auto;
}

.right-nextlv {
  font-size: 3em;    /* ตัวเลขใหญ่ */
  color: #17366a;
  font-weight: bold;
  margin-top: -10px;     /* เผื่อระยะ label ด้านบน */
  margin-bottom: 2px;
  width: 100%;
  text-align: left;
  letter-spacing: 1.2px;
  line-height: 3em;
  word-break: break-all;
  text-align: center;
}

.right-structure {
  width: 100%;  
  min-height: 56px;
  height: auto;
  overflow: hidden;
  white-space: pre-line;
  padding: 50px 2px 8px 12px;
  font-size: 1.5em;
  background: #fafdff;
  border-radius: 12px;
  /* จัดกลางแนวตั้ง-แนวนอน */
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  /* ตัดข้อความถ้าเกิน (ไม่ให้มี scroll bar) */
  overflow: hidden;
  font-weight: bold;
  background: transparent !important;
  color: #fff !important;
  text-shadow: 0 1px 6px #222b;
}


.ko-toast {
  position: absolute;
  left: 0; right: 0;
  top: 8%;
  margin: auto;
  z-index: 9999;
  width: 520px;              /* <<< เพิ่มความกว้าง */
  max-width: 95vw;           /* กว้างสุดไม่เกิน 95% ของจอ */
  background: rgba(18,28,64,0.98);
  color: #fff;
  font-size: 2.15em;         /* <<< ขนาดตัวอักษรใหญ่ขึ้น */
  font-weight: bold;
  padding: 38px 20px;        /* <<< เพิ่ม padding ให้ใหญ่/หนา */
  border-radius: 38px;
  text-align: center;
  box-shadow: 0 10px 36px 0 rgba(0,40,120,0.22);
  pointer-events: none;
  transition: opacity 0.5s;
  opacity: 0;
  /* ลูกเล่น glow */
  box-shadow: 0 0 40px 6px #38e0f966, 0 6px 36px 0 rgba(0,40,120,0.13);
  letter-spacing: 1.2px;
}
.ko-toast.show {
  opacity: 1;
  display: block;
}
body {
  background: #12181f !important;
  min-height: 100vh;
  min-width: 100vw;
  position: relative;
  overflow-x: hidden;
}
#break-overlay {
  position: absolute;
  left: 0; right: 0; top: 31%;
  margin: auto;
  z-index: 15;
  width: 96vw;
  max-width: 820px;
  min-height: 128px;
  background: rgba(18, 24, 34, 0.72);
  color: #ffe86b;
  border-radius: 38px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 2.2em;
  font-weight: bold;
  box-shadow: 0 10px 36px 0 rgba(0,40,120,0.22);
  border: 2px solid #fff8;
  padding: 36px 18px 26px 18px;
  text-align: center;
  letter-spacing: 1.4px;
  text-shadow: 0 2px 12px #111b;
  pointer-events: none;
}
.break-note {
  font-size: 1.0em;
  margin-bottom: 0.35em;
  font-weight: 700;
  color: #fffbe9;
  text-shadow: 0 3px 12px #111b;
}
.break-timer {
  font-size: 2.3em;
  font-weight: 900;
  letter-spacing: 2px;
  color: #ffe86b;
  text-shadow: 0 4px 24px #3e2;
}




  </style>
</head>
<body>
  <audio id="audio-gun" src="gun.mp3" preload="auto"></audio> 
  <audio id="audio-ding" src="ding.mp3" preload="auto"></audio>
<audio id="audio-tick" src="tick.mp3" preload="auto"></audio>
<canvas id="bg-effect" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:0;"></canvas>
  <div class="container">
    <!-- LEFT COLUMN -->
    <div class="col left">
      <div class="info-box">
        
        <div class="logo"><img src="luxu-logo.png" width="50%"></div>
      </div>
      <div class="info-box">
        <h2>Tour State</h2>
        <div class="tour-state"></div>
      </div>
      <div class="info-box">
        <h2>Prize Pool</h2>
        <div class="prize-pool"></div>
      </div>
      <div class="info-box">
        <h2>Pays out</h2>
        <div class="pays-out"></div>
      </div>      
    </div>
    <!-- CENTER COLUMN -->
    <div class="col center">
      <div class="center-box">
        <div class="tournament-name">NO DATA</div>
        <div class="tournament-date">-</div>
        <div class="level-row">
          <div class="level-elapsed" style="font-size: 3em;">Elapsed : 00:00</div>
          <div class="level-now" style="font-size: 3em;">Level 1</div>
          <button id="fullscreen-btn" style="
  position: absolute;
  top: 20px; right: 32px; z-index: 1001;
  font-size: 1.8em;
  background: rgba(255,255,255,0.92);
  color: #1d3557;
  border: none;
  border-radius: 14px;
  padding: 8px 24px;
  box-shadow: 0 2px 10px #0001;
  font-weight: bold;
  cursor: pointer;
  transition: opacity 0.33s;
">FULL SCREEN</button>
        </div>


<div class="timer">00:00</div>
<div id="break-overlay" style="display:none;">
  <div class="break-note"></div>
  <div class="break-timer"></div>
</div>
<div class="timer-controls" style="margin-top: -50px;">
  <button id="btn-fd"><img src="fd.png" alt="FD"></button>
  <button id="btn-play"><img src="play.png" alt="Play"></button>
  <button id="btn-ff"><img src="ff.png" alt="FF"></button>
  <button id="btn-reset"><img src="reset.png" alt="Reset"></button>
</div>
      </div>
      <div class="center-box">
        <div class="middle-row">
          <div class="middle-half next-break">Next Break: -</div>
          <div class="middle-half late-reg">Late Reg.: -</div>
        </div>
      </div>
      <div class="player-box">        
        <div class="player-box-title">Player</div> 
        <div class="ko-toast" id="ko-toast" style="display:none;"></div>
        <div class="player-list"></div>
      </div>
    </div>
    <!-- RIGHT COLUMN -->
    <div class="col right">
      <div class="right-box"><h2>SB</h2><div class="right-sb">-</div></div>
      <div class="right-box"><h2>BB</h2><div class="right-bb">-</div></div>
      <div class="right-box"><h2>ANTE</h2><div class="right-ante">-</div></div>
      <div class="right-box"><h2>Next LV</h2><div class="right-nextlv">-</div></div>
      <div class="right-box"><h2>Blind Structure</h2><div class="right-structure">-</div></div>
    </div>
  </div>
  <script>
let lastKoLogLength = (JSON.parse(// localStorage.getItem (replaced)('koLog') || '[]')).length;
let koToastTimeout = null; 
let timerInterval = null;
let currentLevelIndex = 0;
let timerPaused = true;
let remainSec = 0;
let elapsedSec = 0;
let structureArr = [];
// --- late reg: ล็อกสถานะปิดถาวรหลัง break แรก ---
// ใส่ตรงไหนก็ได้ก่อนฟังก์ชัน (บนสุดสุดหรือหลัง let structureArr ก็ได้)
// --- late reg: ปิดเมื่อหมดเวลา break แรกจริง ๆ ---
function isLateRegClosed(structureArr, currentLevelIndex, remainSec) {
  let lvCount = 0;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lv.type === 'break') {
        if (currentLevelIndex > lvCount) {
          return true; // ข้าม break แรกไปแล้ว
        }
        if (currentLevelIndex === lvCount && remainSec === 0) {
          return true; // อยู่ที่ break แรกและหมดเวลา break
        }
        break;
      }
      lvCount++;
    }
  }
  return false;
}



function loadTimerState() {
  const timerData = JSON.parse(// localStorage.getItem (replaced)('luxu_timer') || '{}');
  timerPaused = (typeof timerData.paused === "boolean") ? timerData.paused : true;
  currentLevelIndex = (typeof timerData.level === "number") ? timerData.level : 0;
  remainSec = (typeof timerData.remainSec === "number") ? timerData.remainSec : 0;
  elapsedSec = (typeof timerData.elapsedSec === "number") ? timerData.elapsedSec : 0;
}
function saveTimerState() {
  // localStorage.setItem (replaced)('luxu_timer', JSON.stringify({
    paused: timerPaused,
    level: currentLevelIndex,
    remainSec,
    elapsedSec
  }));
}

function updateTimerDisplay() {
  document.querySelector('.timer').textContent = formatMMSS(remainSec);
  // คำนวณ elapsed รวมจริง!
  let elapsedTotal = getTotalElapsedSec(structureArr, currentLevelIndex, remainSec);
  document.querySelector('.level-elapsed').textContent = "Elapsed: " + formatMMSS(elapsedTotal);
}


function setTimerControlIcons() {
  const playBtn = document.getElementById('btn-play').querySelector('img');
  playBtn.src = timerPaused ? "play.png" : "pause.png";
}

function startTimerTick() {
  clearInterval(timerInterval);
  if (!timerPaused) {
    timerInterval = setInterval(() => {
      if (remainSec > 0) {
        remainSec--;
        elapsedSec++;
        updateTimerDisplay();
        saveTimerState();
        if (remainSec === 60) {
    try { document.getElementById('audio-ding').play(); } catch(e){}
  }
  if (remainSec <= 10 && remainSec > 0) {
    try { document.getElementById('audio-tick').play(); } catch(e){}
  }

        // --- อัปเดต late reg ---
        const lateRegBox = document.querySelector('.late-reg');
if (isLateRegClosed(structureArr, currentLevelIndex)) {
          lateRegBox.textContent = "CLOSED";
          lateRegBox.classList.add("closed");
          lateRegBox.classList.remove("open");
        } else {
          const secToLateReg = getSecondsUntilEndOfFirstBreak(structureArr, currentLevelIndex, remainSec);
          if (secToLateReg > 0) {
            const m = Math.floor(secToLateReg / 60);
            const s = secToLateReg % 60;
            lateRegBox.textContent = `Late Reg: ${m}:${String(s).padStart(2, '0')}`;
            lateRegBox.classList.add("open");
            lateRegBox.classList.remove("closed");
          } else {
            lateRegBox.textContent = "CLOSED";
            lateRegBox.classList.add("closed");
            lateRegBox.classList.remove("open");
          }
        }



        // --- อัปเดต next break ---
        const secToBreak = getSecondsUntilNextBreak(structureArr, currentLevelIndex, remainSec);
        if (secToBreak > 0 && secToBreak < 60*60*24) {
          const m = Math.floor(secToBreak / 60);
          const s = secToBreak % 60;
          document.querySelector('.next-break').textContent =
            `Next Break: ${m}:${String(s).padStart(2, '0')}`;
        } else {
          document.querySelector('.next-break').textContent = "Next Break: -";
        }

      } else {
        // auto next level
        currentLevelIndex++;
        saveTimerState();
        try { document.getElementById('audio-ding').play(); } catch(e){}
        showCurrentLevel(structureArr);
      }
    }, 1000);
  }
}

function handlePlayPause() {
  try { document.getElementById('audio-ding').play(); document.getElementById('audio-ding').pause(); document.getElementById('audio-ding').currentTime = 0; } catch(e){}
  try { document.getElementById('audio-tick').play(); document.getElementById('audio-tick').pause(); document.getElementById('audio-tick').currentTime = 0; } catch(e){}
  timerPaused = !timerPaused;
  setTimerControlIcons();
  saveTimerState();
  startTimerTick();
}

function handleFF() {
  currentLevelIndex++;
  if (currentLevelIndex >= structureArr.filter(lv => lv.type === 'level' || lv.type === 'break').length) {
    currentLevelIndex = structureArr.filter(lv => lv.type === 'level' || lv.type === 'break').length - 1;
  }
  saveTimerState();
  renderDisplay(); // <<< เรียกใหม่ทั้งหน้าจอ
}

function handleFD() {
  currentLevelIndex--;
  if (currentLevelIndex < 0) currentLevelIndex = 0;
  saveTimerState();
  renderDisplay(); // <<< เรียกใหม่ทั้งหน้าจอ
}


function formatMMSS(sec) {
  sec = Math.max(0, sec|0);
  const m = String(Math.floor(sec/60)).padStart(2, "0");
  const s = String(sec%60).padStart(2, "0");
  return `${m}:${s}`;
}

function renderNoData() {
  document.querySelector('.tournament-name').textContent = 'NO DATA';
  document.querySelector('.tournament-date').textContent = '-';
  document.querySelector('.level-now').textContent = '-';
  document.querySelector('.level-elapsed').textContent = '-';
  document.querySelector('.timer').textContent = '-';
  document.querySelector('.prize-pool').textContent = '-';
  document.querySelector('.pays-out').textContent = '-';
  document.querySelector('.tour-state').textContent = '-';
  document.querySelector('.player-list').textContent = '-';
  document.querySelector('.right-sb').textContent = '-';
  document.querySelector('.right-bb').textContent = '-';
  document.querySelector('.right-ante').textContent = '-';
  document.querySelector('.right-nextlv').textContent = '-';
  document.querySelector('.right-structure').textContent = '-';
  document.querySelector('.next-break').textContent = 'Next Break: -';
  document.querySelector('.late-reg').textContent = 'Late Reg.: -';
}

function getTourKeyFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('tourKey') || urlParams.get('tour');
}

function renderDisplay() {
  
  const key = getTourKeyFromURL();
  if (!key) { renderNoData(); return; }
  let tourObj;
  try { tourObj = JSON.parse(// localStorage.getItem (replaced)(key)); } catch { tourObj = null; }
  if (!tourObj || !tourObj.info) { renderNoData(); return; }
  const info = tourObj.info;
  const players = tourObj.players || [];

  // --- (1) Tour State ---
  let rebuy = 0, addon = 0;
  players.forEach(p => {
    rebuy += p.rebuyUsed || 0;
    addon += p.addonUsed ? 1 : 0;
  });
  let entry = players.length;
  let alive = (info.type === "Bounty") ?
    players.filter(p => p.status === "Alive").length :
    players.filter(p => p.status === "Active").length;
  let startingStack = parseFloat(info.startingStack || 0);
  let addonStack = parseFloat(info.addonStack || 0);
  let totalStack = (entry + rebuy) * startingStack + (addon * addonStack);
  let avgStack = alive > 0 ? Math.round(totalStack / alive) : 0;
  let tourStateHTML = `
    <b>Entries:</b> ${entry} / ${alive}<br>
    <b>Re-Entry:</b> ${rebuy}<br>
    <b>Add-on:</b> ${addon}<br>
    <b>Total Stack:</b> ${totalStack.toLocaleString()}<br>
    <b>Average Stack:</b> ${avgStack.toLocaleString()}
  `;
  document.querySelector('.tour-state').innerHTML = tourStateHTML;

  // --- (2) Prize Pool ---
  let buyIn = parseFloat(info.buyIn || 0);
  let reBuy = parseFloat(info.rebuy || 0);
  let addOn = parseFloat(info.addon || 0);
  let prizePool = 0, bountyPool = 0;
  let rebuyCount = rebuy, addonCount = addon;
  if (info.type === "Bounty") {
    prizePool = ((buyIn/2) * entry) + ((reBuy/2) * rebuyCount) + (addOn * addonCount);
    bountyPool = ((buyIn/2) * entry) + ((reBuy/2) * rebuyCount);
    document.querySelector('.prize-pool').innerHTML =
      `<b>Prize:</b> ${prizePool.toLocaleString()}<br><b>Bounty:</b> ${bountyPool.toLocaleString()}`;
  } else {
    prizePool = (buyIn * entry) + (reBuy * rebuyCount) + (addOn * addonCount);
    document.querySelector('.prize-pool').textContent = prizePool.toLocaleString();
  }

  // --- (3) Pays Out ---
  const prizeSettings = JSON.parse(// localStorage.getItem (replaced)(key + '_prizeSettings') || '{}');
  const percents = prizeSettings.percents || [];
  const nWinners = prizeSettings.nWinners || percents.length;
  if (prizePool > 0 && nWinners > 0 && percents.length > 0) {
    let html = `<table class="payout-table"><tr><th>อันดับ</th><th>จำนวนเงิน</th><th>%</th></tr>`;
    for (let i = 0; i < nWinners; i++) {
      let percent = percents[i] || 0;
      let amount = Math.round(prizePool * percent / 100);
      html += `<tr><td>${i+1}</td><td>${amount.toLocaleString()}</td><td>${percent}</td></tr>`;
    }
    html += "</table>";
    document.querySelector('.pays-out').innerHTML = html;
  } else {
    document.querySelector('.pays-out').textContent = '-';
  }

  // --- (4) Player List ---
    setupPlayerAutoScroll(players, info);


// --- (5) Blind Structure: แถวแรกคือสิ่งถัดไปจริง, สูงสุด 6 บรรทัด ---
structureArr = tourObj.blindStructure || [];
let structHtml = '-';
if (Array.isArray(structureArr) && structureArr.length > 0) {
  // 1. array ของ level/break
  let arr = [];
  for (let i = 0; i < structureArr.length; i++) {
    if (structureArr[i].type === "level" || structureArr[i].type === "break") {
      arr.push({...structureArr[i], _idx: i});
    }
  }
  // 2. หา LV ล่าสุด
  let lvNum = 1;
  for (let i = 0; i <= currentLevelIndex && i < arr.length; i++) {
    if (arr[i].type === "level") lvNum++;
  }
  // 3. slice เฉพาะสิ่งถัดไป (currentLevelIndex+1) และไม่เกิน 6 แถว
  if (currentLevelIndex + 1 < arr.length) {
    structHtml = arr.slice(currentLevelIndex + 1, currentLevelIndex + 7).map(item => {
      if (item.type === "level") {
        return `LV${lvNum++}- ${item.sb}/${item.bb}/${item.ante}`;
      } else if (item.type === "break") {
        return "Break";
      } else {
        return "";
      }
    }).join('<br>');
  } else {
    structHtml = "-";
  }
}
document.querySelector('.right-structure').innerHTML = structHtml;




  // --- (6) Tournament Name, Date & Late Reg/Break ---
  document.querySelector('.tournament-name').textContent = info.name || 'NO DATA';
  updateDateTime();
  setInterval(updateDateTime, 1000);
  document.querySelector('.late-reg').textContent =
    "Late Reg.: " + (info.lateReg || '-');

  // --- (7) TIMER/LEVEL/ELAPSED ---
  loadTimerState();
  
setTimerControlIcons();
updateTimerDisplay();
  showCurrentLevel(structureArr);
  setTimerControlIcons();
  updateTimerDisplay();

  // --- (8) ปุ่มควบคุม ---
  document.getElementById('btn-play').onclick = handlePlayPause;
  document.getElementById('btn-ff').onclick = handleFF;
  document.getElementById('btn-fd').onclick = handleFD;
  checkAndShowNewKoLog();
}

function checkAndShowNewKoLog() {
  let koLog = JSON.parse(// localStorage.getItem (replaced)('koLog') || '[]');
  if (koLog.length > lastKoLogLength) {
    const item = koLog[koLog.length-1];
    showKoToast(item.action);
    lastKoLogLength = koLog.length;  // อัปเดตความยาวเมื่อ KO ใหม่
  }
}


// เรียก checkAndShowNewKoLog() ทุกครั้งหลัง renderDisplay()


function showCurrentLevel(structureArr) {
  function getNextLevelObj(structureArr, currentLevelIndex) {
    let lvNum = 0;
    for (let i = 0; i < structureArr.length; i++) {
      if (structureArr[i].type === "level") {
        if (lvNum === currentLevelIndex + 1) return structureArr[i];
        lvNum++;
      }
    }
    return null;
  }

  if (!Array.isArray(structureArr) || !structureArr.length) return;

  // หาเลเวลปัจจุบัน
  let lvCount = 0;
  let targetIndex = null;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lvCount === currentLevelIndex) {
        targetIndex = i;
        break;
      }
      lvCount++;
    }
  }
  if (targetIndex === null) return;
  const lv = structureArr[targetIndex];

  // แสดง Level/Break + SB/BB/ANTE
  if (lv.type === "level") {
    document.querySelector('.level-now').textContent = `Level ${currentLevelIndex+1}`;
    document.querySelector('.right-sb').textContent = lv.sb || '-';
    document.querySelector('.right-bb').textContent = lv.bb || '-';
    document.querySelector('.right-ante').textContent = lv.ante || '-';
  } else if (lv.type === "break") {
    document.querySelector('.level-now').textContent = "Break";
    document.querySelector('.right-sb').textContent = '-';
    document.querySelector('.right-bb').textContent = '-';
    document.querySelector('.right-ante').textContent = '-';
  }

  // Next LV
  const nextLvObj = getNextLevelObj(structureArr, currentLevelIndex);
  if (nextLvObj) {
    document.querySelector('.right-nextlv').textContent =
      `${nextLvObj.sb || '-'} / ${nextLvObj.bb || '-'} / ${nextLvObj.ante || '-'}`;
  } else {
    document.querySelector('.right-nextlv').textContent = '-';
  }

  updateTimerDisplay();
  clearInterval(timerInterval);

  if (!timerPaused) {
    timerInterval = setInterval(() => {
      if (remainSec > 0) {
        remainSec--;
        elapsedSec++;
        updateTimerDisplay();
        saveTimerState();
        // ใน interval ของ showCurrentLevel
if (lv.type === "break") {
  document.getElementById('break-overlay')
    .querySelector('.break-timer').textContent = formatMMSS(remainSec);
}


        // --- อัปเดต late reg & next break ให้ล็อก CLOSED ถาวร ---
const lateRegBox = document.querySelector('.late-reg');
if (isLateRegClosed(structureArr, currentLevelIndex)) {
  lateRegBox.textContent = "CLOSED";
  lateRegBox.classList.add("closed");
  lateRegBox.classList.remove("open");
} else {
  const secToLateReg = getSecondsUntilEndOfFirstBreak(structureArr, currentLevelIndex, remainSec);
  if (secToLateReg > 0) {
    const m = Math.floor(secToLateReg / 60);
    const s = secToLateReg % 60;
    lateRegBox.textContent = `Late Reg: ${m}:${String(s).padStart(2, '0')}`;
    lateRegBox.classList.add("open");
    lateRegBox.classList.remove("closed");
  } else {
    lateRegBox.textContent = "CLOSED";
    lateRegBox.classList.add("closed");
    lateRegBox.classList.remove("open");
  }
  // --- BREAK OVERLAY LOGIC ---
const overlay = document.getElementById('break-overlay');
if (lv.type === "break") {
  overlay.style.display = "";
  overlay.querySelector('.break-note').textContent =
    "☕ BREAK: " + (lv.note || "พักเบรก");
  overlay.querySelector('.break-timer').textContent = formatMMSS(remainSec);
} else {
  overlay.style.display = "none";
}

}
// --- จบ late reg & next break ---


        const secToBreak = getSecondsUntilNextBreak(structureArr, currentLevelIndex, remainSec);
        if (secToBreak > 0 && secToBreak < 60*60*24) {
          const m = Math.floor(secToBreak / 60);
          const s = secToBreak % 60;
          document.querySelector('.next-break').textContent =
            `Next Break: ${m}:${String(s).padStart(2, '0')}`;
        } else {
          document.querySelector('.next-break').textContent = "Next Break: -";
        }
      } else {
        currentLevelIndex++;
        let lvCount2 = 0, targetIndex2 = null;
        for (let i = 0; i < structureArr.length; i++) {
          const lvx = structureArr[i];
          if (lvx.type === 'level' || lvx.type === 'break') {
            if (lvCount2 === currentLevelIndex) {
              targetIndex2 = i;
              break;
            }
            lvCount2++;
          }
        }
        if (targetIndex2 !== null) {
          const lvx = structureArr[targetIndex2];
          remainSec = parseInt(lvx.duration || 15) * 60;
          elapsedSec = 0;
        } else {
          remainSec = 0;
          elapsedSec = 0;
        }
        saveTimerState();
        showCurrentLevel(structureArr);
      }
    }, 1000);
  }

  // แสดง late reg/next break ให้เห็น (ตอน pause หรือรีเฟรช)
  const lateRegBox = document.querySelector('.late-reg');
if (isLateRegClosed(structureArr, currentLevelIndex)) {
  lateRegBox.textContent = "CLOSED";
  lateRegBox.classList.add("closed");
  lateRegBox.classList.remove("open");
} else {
  const lateRegBox = document.querySelector('.late-reg');
if (isLateRegClosed(structureArr, currentLevelIndex)) {
  lateRegBox.textContent = "CLOSED";
  lateRegBox.classList.add("closed");
  lateRegBox.classList.remove("open");
} else {
  const secToLateReg = getSecondsUntilEndOfFirstBreak(structureArr, currentLevelIndex, remainSec);
  if (secToLateReg > 0) {
    const m = Math.floor(secToLateReg / 60);
    const s = secToLateReg % 60;
    lateRegBox.textContent = `Late Reg: ${m}:${String(s).padStart(2, '0')}`;
    lateRegBox.classList.add("open");
    lateRegBox.classList.remove("closed");
  } else {
    lateRegBox.textContent = "CLOSED";
    lateRegBox.classList.add("closed");
    lateRegBox.classList.remove("open");
  }
}

}


 if (remainSec === 60) {
    try { document.getElementById('audio-ding').play(); } catch(e){}
}
if (remainSec <= 10 && remainSec > 0) {
    try { document.getElementById('audio-tick').play(); } catch(e){}
    const m = Math.floor(secToBreak / 60);
    const s = secToBreak % 60;
    document.querySelector('.next-break').textContent =
      `Next Break: ${m}:${String(s).padStart(2, '0')}`;
  } else {
    document.querySelector('.next-break').textContent = "Next Break: -";
  }
}

function getSecondsUntilNextBreak(structureArr, currentLevelIndex, remainSecCurrentLevel) {
  let sec = remainSecCurrentLevel;
  let lvCount = 0;
  let foundCurrent = false;
  let foundBreak = false;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (!foundCurrent) {
        if (lvCount === currentLevelIndex) foundCurrent = true;
        lvCount++;
        continue;
      }
      // ถ้าเจอ break ให้หยุด (***อย่า*** บวก duration break)
      if (lv.type === 'break') {
        foundBreak = true;
        break;
      }
      sec += parseInt(lv.duration || 15) * 60;
      lvCount++;
    }
  }
  if (!foundBreak) return -1;
  return sec;
}




function getSecondsUntilEndOfFirstBreak(structureArr, currentLevelIndex, remainSecCurrentLevel) {
  // 1. หา index ของ break แรก
  let lvCount = 0;
  let firstBreakIndex = null;
  let breakDuration = 0;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lv.type === 'break' && firstBreakIndex === null) {
        firstBreakIndex = lvCount;
        breakDuration = parseInt(lv.duration || 15) * 60;
        break;
      }
      lvCount++;
    }
  }
  if (firstBreakIndex === null) return 0; // ไม่มี break แรก

  // 2. ถ้า currentLevelIndex > break แรก = ปิด late reg
  if (currentLevelIndex > firstBreakIndex) return 0;

  // 3. ถ้าอยู่ที่ break แรก ให้คืน remainSecCurrentLevel
  if (currentLevelIndex === firstBreakIndex) return remainSecCurrentLevel;

  // 4. ถ้ายังไม่ถึง break แรก ให้รวมเวลาที่เหลือของแต่ละเลเวล + เวลา break แรก
  let sec = remainSecCurrentLevel;
  lvCount = 0;
  let foundCurrent = false;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (!foundCurrent) {
        if (lvCount === currentLevelIndex) foundCurrent = true;
        lvCount++;
        continue;
      }
      if (lv.type === 'break') {
        sec += parseInt(lv.duration || 15) * 60;
        break;
      }
      sec += parseInt(lv.duration || 15) * 60;
      lvCount++;
    }
  }
  return sec;
}




function updateDateTime() {
  const el = document.querySelector('.tournament-date');
  if (!el) return;
  const now = new Date();
  const dateStr = now.toLocaleDateString('th-TH', {year: 'numeric', month: 'short', day: 'numeric'});
  const timeStr = now.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
  el.textContent = `${dateStr} ${timeStr}`;
}

window.onload = renderDisplay;
document.getElementById('btn-reset').onclick = resetTimer;
function setLevelAndResetTimer(levelIdx) {
  lateRegClosed = false; 
  currentLevelIndex = levelIdx;
  // หา duration ของเลเวลใหม่
  let lvCount = 0;
  let targetIndex = null;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lvCount === currentLevelIndex) {
        targetIndex = i;
        break;
      }
      lvCount++;
    }
  }
  if (targetIndex !== null) {
    const lv = structureArr[targetIndex];
    remainSec = parseInt(lv.duration || 15) * 60;
    elapsedSec = 0;
  } else {
    remainSec = 0;
    elapsedSec = 0;
  }
  saveTimerState();
  showCurrentLevel(structureArr);
}
function resetTimer() {
  lateRegClosed = false; // --- reset สถานะ late reg ปิดถาวร ---
  currentLevelIndex = 0;
  
  // หา duration ของเลเวลแรก
  let lvCount = 0;
  let targetIndex = null;
  
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lvCount === 0) {
        targetIndex = i;
        break;
      }
      lvCount++;
    }
  }
  if (targetIndex !== null) {
    const lv = structureArr[targetIndex];
    remainSec = parseInt(lv.duration || 15) * 60;
    elapsedSec = 0;
  } else {
    remainSec = 0;
    elapsedSec = 0;
  }
  timerPaused = true;
  saveTimerState();
  setTimerControlIcons();
  showCurrentLevel(structureArr);
}

window.addEventListener('storage', function(event) {
  const key = getTourKeyFromURL();
  if (
    event.key === key || 
    event.key === key + '_prizeSettings' ||
    event.key === 'luxu_timer' ||
    event.key === 'koLog'      // <----- เพิ่มตรงนี้!
  ) {
    renderDisplay();
    checkAndShowNewKoLog();
  }
});



function showKoToast(msg) {
  const el = document.getElementById('ko-toast');
  el.textContent = msg;
  el.classList.add('show');
  el.style.display = 'block';
  try {
    const gunAudio = document.getElementById('audio-gun');
    gunAudio.currentTime = 0;
    gunAudio.play();
  } catch(e){}
  clearTimeout(koToastTimeout);
  koToastTimeout = setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.style.display = 'none', 500);
  }, 15000); // 15 วินาที
}
function getTotalElapsedSec(structureArr, currentLevelIndex, remainSec) {
  // เวลาที่จบเลเวล/เบรก ก่อนหน้า
  let elapsed = 0;
  let lvCount = 0;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (lvCount < currentLevelIndex) {
        elapsed += parseInt(lv.duration || 0) * 60;
      }
      lvCount++;
    }
  }
  // + เวลาที่ใช้จริงในเลเวลปัจจุบัน
  let idx = 0, targetIdx = null;
  for (let i = 0; i < structureArr.length; i++) {
    const lv = structureArr[i];
    if (lv.type === 'level' || lv.type === 'break') {
      if (idx === currentLevelIndex) {
        targetIdx = i;
        break;
      }
      idx++;
    }
  }
  if (targetIdx !== null) {
    const currLv = structureArr[targetIdx];
    let dur = parseInt(currLv.duration || 0) * 60;
    elapsed += (dur - remainSec);
  }
  return Math.max(0, elapsed);
}

let playerScrollIndex = 0;
let playerScrollTimer = null;

function renderPlayerListAuto(players, info) {
  const playerListEl = document.querySelector('.player-list');
  if (!players.length) {
    playerListEl.innerHTML = "-";
    return;
  }
  let pageSize = 5;
  let list = players.slice(playerScrollIndex, playerScrollIndex + pageSize);
  // ถ้าไม่ครบ 5 รายชื่อ ให้วนเอาจากต้น array
  if (list.length < pageSize && players.length > pageSize) {
    list = list.concat(players.slice(0, pageSize - list.length));
  }

  let html = "";
  if (info.type === "Bounty") {
    html = `<table class="player-table">
      <thead>
        <tr>
          <th>#</th>
          <th>NAME</th>
          <th>BOUNTY</th>
        </tr>
      </thead>
      <tbody>
        ${
          list.map((p, i) => `
            <tr>
              <td>${((playerScrollIndex + i) % players.length) + 1}</td>
              <td>${p.name || '-'}</td>
              <td>${p.bounty != null ? p.bounty : '-'}</td>
            </tr>
          `).join('')
        }
      </tbody>
    </table>`;
  } else {
    html = `<table class="player-table">
      <thead>
        <tr>
          <th>#</th>
          <th>NAME</th>
          <th>STATUS</th>
        </tr>
      </thead>
      <tbody>
        ${
          list.map((p, i) => `
            <tr>
              <td>${((playerScrollIndex + i) % players.length) + 1}</td>
              <td>${p.name || '-'}</td>
              <td>${p.status || '-'}</td>
            </tr>
          `).join('')
        }
      </tbody>
    </table>`;
  }

  playerListEl.innerHTML = html;
}

function setupPlayerAutoScroll(players, info) {
  clearInterval(window._playerScrollTimer);
  playerScrollIndex = 0;

  let showPlayers;
  if (info.type === "Bounty") {
    showPlayers = players.filter(p => (p.status || '').toLowerCase() === "alive");
    showPlayers.sort((a, b) => {
      let ba = (parseFloat(a.bounty) || 0), bb = (parseFloat(b.bounty) || 0);
      if (bb !== ba) return bb - ba;
      return (a.name || '').localeCompare(b.name || '');
    });
  } else {
    showPlayers = players.filter(p => (p.status || '').toLowerCase() === "active");
  }

  // ถ้าเหลือ 1 คน ให้แสดงเป็นแชมป์
  if (showPlayers.length === 1) {
    const championName = showPlayers[0].name || "UNKNOWN";
    document.querySelector('.player-list').innerHTML = `
      <div style="text-align:center; font-size:3em; font-weight:900; color:#FFB800; letter-spacing:2px; padding:32px 0;">
        🏆 CHAMPION 🏆<br>
        <span style="font-size:2em; color:#18305b;">${championName}</span>
      </div>
    `;
    return;
  }

  renderPlayerListAuto(showPlayers, info);

  if (showPlayers.length > 5) {
    window._playerScrollTimer = setInterval(() => {
      playerScrollIndex += 5;
      if (playerScrollIndex >= showPlayers.length) playerScrollIndex = 0;
      renderPlayerListAuto(showPlayers, info);
    }, 10000); // หรือ 15000 ตามต้องการ
  }
}
// --- FULL SCREEN BUTTON LOGIC ---
const fullscreenBtn = document.getElementById('fullscreen-btn');
fullscreenBtn.onclick = function() {
  // Request fullscreen
  const elem = document.documentElement;
  if (elem.requestFullscreen) elem.requestFullscreen();
  else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
  else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
  else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
  // ซ่อนปุ่ม (จางออก)
  fullscreenBtn.style.opacity = "0";
  fullscreenBtn.style.pointerEvents = "none";
  // Save state
  // localStorage.setItem (replaced)('display_fs_hidden', "1");
}

// เมื่อออกจาก fullscreen ให้โชว์ปุ่มอัตโนมัติ
document.addEventListener('fullscreenchange', function() {
  if (!document.fullscreenElement) {
    fullscreenBtn.style.opacity = "1";
    fullscreenBtn.style.pointerEvents = "";
    localStorage.removeItem('display_fs_hidden');
  }
});

// เผื่อใช้ browser อื่นๆ
document.addEventListener('webkitfullscreenchange', function() {
  if (!document.webkitIsFullScreen) {
    fullscreenBtn.style.opacity = "1";
    fullscreenBtn.style.pointerEvents = "";
    localStorage.removeItem('display_fs_hidden');
  }
});
document.addEventListener('mozfullscreenchange', function() {
  if (!document.mozFullScreen) {
    fullscreenBtn.style.opacity = "1";
    fullscreenBtn.style.pointerEvents = "";
    localStorage.removeItem('display_fs_hidden');
  }
});
document.addEventListener('msfullscreenchange', function() {
  if (!document.msFullscreenElement) {
    fullscreenBtn.style.opacity = "1";
    fullscreenBtn.style.pointerEvents = "";
    localStorage.removeItem('display_fs_hidden');
  }
});

// เมื่อรีเฟรชหรือเปิดใหม่ ถ้าไม่ fullscreen ให้โชว์ปุ่ม
window.addEventListener('DOMContentLoaded', function() {
  if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
    fullscreenBtn.style.opacity = "1";
    fullscreenBtn.style.pointerEvents = "";
    localStorage.removeItem('display_fs_hidden');
  }
});

window.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('bg-effect');
  const ctx = canvas.getContext('2d');
  let w = window.innerWidth, h = window.innerHeight;
  canvas.width = w; canvas.height = h;
  window.addEventListener('resize', ()=>{
    w = window.innerWidth; h = window.innerHeight;
    canvas.width = w; canvas.height = h;
  });

  // --------- ดาวกระพริบ ---------
  const nStars = 120;
  const stars = [];
  for (let i=0; i<nStars; i++) {
    stars.push({
  x: Math.random()*w,
  y: Math.random()*h,
  r: 0.7+Math.random()*1.3,
  alpha: 0.2+Math.random()*0.7,
  blink: Math.random()*0.025 + 0.008, // <<< ปรับให้ช้าลง
  dir: Math.random()<0.5?-1:1
});

  }

  // --------- ดาวตก ---------
  const nShooting = 2; // จำนวนดาวตกบนจอในแต่ละเวลา
  const shootings = [];
  function spawnShootingStar() {
    // สุ่มจุดกำเนิดใหม่
    shootings.push({
      x: Math.random()*w,
      y: Math.random()*h*0.45,
      dx: 2+Math.random()*5,
      dy: 2+Math.random()*4,
      len: 60+Math.random()*160,
      life: 0,
      ttl: 60+Math.random()*50, // อายุ
      color: "#fff"
    });
    // จำกัดดาวตกในจอ
    if (shootings.length > nShooting) shootings.shift();
  }

  let frame = 0;
  function animate() {
    ctx.clearRect(0,0,w,h);

    // วาดดาวกระพริบ
    for(const s of stars) {
      ctx.save();
      ctx.globalAlpha = s.alpha;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, 2*Math.PI);
      ctx.fillStyle = "#fff";
      ctx.shadowColor = "#fff";
      ctx.shadowBlur = 8;
      ctx.fill();
      ctx.restore();
      // กระพริบ
      s.alpha += s.blink * s.dir;
      if(s.alpha > 1){ s.dir = -1; s.alpha = 1; }
      if(s.alpha < 0.1){ s.dir = 1; s.alpha = 0.1; }
    }

    // วาดดาวตก
    for(const s of shootings) {
      ctx.save();
      ctx.globalAlpha = 0.8 * Math.max(0, 1-s.life/s.ttl);
      ctx.strokeStyle = s.color;
      ctx.lineWidth = 0.6 + (s.len/80);
      ctx.shadowColor = s.color + "9";
      ctx.shadowBlur = 8;
      ctx.beginPath();
      ctx.moveTo(s.x, s.y);
      ctx.lineTo(s.x - s.dx*s.len/9, s.y - s.dy*s.len/9); // head
      ctx.stroke();
      ctx.restore();
      // move
      s.x += s.dx;
      s.y += s.dy;
      s.life++;
    }
    // ลบดาวตกหมดอายุ
    for(let i=shootings.length-1;i>=0;i--){
      if(shootings[i].life > shootings[i].ttl) shootings.splice(i,1);
    }
    // spawn ดาวตกใหม่
    if(frame%Math.floor(120+Math.random()*60)===0) spawnShootingStar();

    frame++;
    requestAnimationFrame(animate);
  }
  animate();
});


</script>


<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDqd20lb2fQSMjqsSmzUXXgQFhBNC8sB9g",
    authDomain: "luxutour-63450.firebaseapp.com",
    projectId: "luxutour-63450",
    storageBucket: "luxutour-63450.firebasestorage.app",
    messagingSenderId: "349190270077",
    appId: "1:349190270077:web:c52b936bdc2f06c7db1514",
    measurementId: "G-1F45DPS42M"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Auth guard
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      const urlParams = new URLSearchParams(window.location.search);
      const tourKey = urlParams.get("tourKey") || "default";
      const docRef = db.collection("displayData").doc(tourKey);
      docRef.onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          // You must replace the below logic with actual field mapping
          if (data.tournamentName) {
            const el = document.getElementById("tournamentName");
            if (el) el.textContent = data.tournamentName;
          }
          if (data.blindLevel) {
            const el = document.getElementById("blindLevel");
            if (el) el.textContent = data.blindLevel;
          }
          // Add more mappings as needed...
        }
      });
    }
  });
</script>


<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  const tourRef = db.collection("tournaments").doc(tourKey);

  tourRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      document.getElementById("tourName").textContent = data.info?.name || "No Name";
      document.getElementById("entryInfo").textContent = "Entry Fee: $" + (data.prizeSettings?.entryFee || "0");
      document.getElementById("totalEntry").textContent = "Total Entries: " + (data.prizeSettings?.totalEntry || "0");
      document.getElementById("guarantee").textContent = "Guarantee: $" + (data.prizeSettings?.guarantee || "0");
      // สามารถเพิ่มข้อมูลอื่นได้อีก เช่น players, prize note, etc.
    }
  });
</script>


<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  const tourRef = db.collection("tournaments").doc(tourKey);

  tourRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      document.getElementById("tourName").textContent = data.info?.name || "No Name";
      document.getElementById("entryInfo").textContent = "Entry Fee: $" + (data.prizeSettings?.entryFee || "0");
      document.getElementById("totalEntry").textContent = "Total Entries: " + (data.prizeSettings?.totalEntry || "0");
      document.getElementById("guarantee").textContent = "Guarantee: $" + (data.prizeSettings?.guarantee || "0");

      // Display blind info (latest level)
      const levels = data.structure || [];
      const last = levels[levels.length - 1] || {};
      document.getElementById("blindInfo").textContent = `Current Blind: ${last.sb || "?"}/${last.bb || "?"} (Ante: ${last.ante || 0})`;

      // Player list
      const playerList = document.getElementById("playerList");
      if (playerList) {
        playerList.innerHTML = "";
        (data.players || []).forEach(p => {
          const li = document.createElement("li");
          li.textContent = `${p.name} (${p.status || "Active"})`;
          playerList.appendChild(li);
        });
      }
    }
  });
</script>


<script>
  const tourKey = sessionStorage.getItem("currentTourKey");
  if (!tourKey) {
    alert("No tournament selected. Redirecting...");
    window.location.href = "index.html";
  }

  const tourRef = db.collection("tournaments").doc(tourKey);
  tourRef.onSnapshot(doc => {
    if (!doc.exists) return;
    const data = doc.data();

    const safeText = (id, txt) => {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    };

    safeText("tourName", data.info?.name || "No Name");
    safeText("entryInfo", "Entry Fee: $" + (data.prizeSettings?.entryFee || "0"));
    safeText("totalEntry", "Total Entries: " + (data.prizeSettings?.totalEntry || "0"));
    safeText("guarantee", "Guarantee: $" + (data.prizeSettings?.guarantee || "0"));

    const levels = data.structure || [];
    const last = levels[levels.length - 1] || {};
    safeText("blindInfo", `Current Blind: ${last.sb || "?"}/${last.bb || "?"} (Ante: ${last.ante || 0})`);

    const playerList = document.getElementById("playerList");
    if (playerList) {
      playerList.innerHTML = "";
      (data.players || []).forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name} (${p.status || "Active"})`;
        playerList.appendChild(li);
      });
    }
  });
</script>

</body>
</html>
